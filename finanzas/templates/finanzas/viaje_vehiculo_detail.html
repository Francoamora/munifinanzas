{% extends "finanzas/base.html" %}
{% load humanize %}

{% block title %}
  Viaje {{ viaje.vehiculo|default:"(sin vehículo)" }} – {{ viaje.fecha_salida|date:"d/m/Y" }}
{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
  <div>
    <h1 class="h4 mb-1">
      Viaje de vehículo
      {% if viaje.vehiculo %}
        – {{ viaje.vehiculo }}
      {% endif %}
    </h1>
    <div class="text-muted small">
      Detalle del viaje, kilómetros recorridos y consumos de combustible vinculados.
    </div>
  </div>

  <div class="btn-group">
    <a href="{% url 'finanzas:viaje_vehiculo_list' %}?vehiculo={{ viaje.vehiculo_id }}" class="btn btn-outline-secondary btn-sm">
      Volver a viajes
    </a>
    {% if viaje.vehiculo_id %}
      <a href="{% url 'finanzas:vehiculo_detail' viaje.vehiculo_id %}" class="btn btn-outline-secondary btn-sm">
        Ver vehículo
      </a>
    {% endif %}
    <a href="{% url 'finanzas:viaje_vehiculo_update' viaje.pk %}" class="btn btn-primary btn-sm">
      Editar viaje
    </a>
  </div>
</div>

<div class="row g-3 mb-3">
  <!-- Columna izquierda: datos generales -->
  <div class="col-md-6">
    <div class="card shadow-sm h-100">
      <div class="card-header py-2">
        <strong>Datos generales</strong>
      </div>
      <div class="card-body small">
        <dl class="row mb-0">
          <dt class="col-4">Vehículo</dt>
          <dd class="col-8">
            {% if viaje.vehiculo %}
              {{ viaje.vehiculo }}
            {% else %}
              <span class="text-muted">No asignado</span>
            {% endif %}
          </dd>

          <dt class="col-4">Área</dt>
          <dd class="col-8">
            {{ viaje.area|default:"-" }}
          </dd>

          <dt class="col-4">Chofer</dt>
          <dd class="col-8">
            {% if viaje.chofer %}
              {{ viaje.chofer.apellido }} {{ viaje.chofer.nombre }}
            {% else %}
              <span class="text-muted">Sin chofer asignado</span>
            {% endif %}
          </dd>

          <dt class="col-4">Estado</dt>
          <dd class="col-8">
            {% if viaje.get_estado_display %}
              <span class="badge bg-secondary-subtle text-dark border border-secondary-subtle">
                {{ viaje.get_estado_display }}
              </span>
            {% else %}
              <span class="text-muted">-</span>
            {% endif %}
          </dd>

          <dt class="col-4">Origen</dt>
          <dd class="col-8">{{ viaje.origen|default:"-" }}</dd>

          <dt class="col-4">Destino</dt>
          <dd class="col-8">{{ viaje.destino|default:"-" }}</dd>

          <dt class="col-4">Motivo</dt>
          <dd class="col-8">
            {% if viaje.motivo %}
              {{ viaje.motivo }}
            {% else %}
              <span class="text-muted">No registrado</span>
            {% endif %}
          </dd>
        </dl>
      </div>
    </div>
  </div>

  <!-- Columna derecha: fechas / odómetro -->
  <div class="col-md-6">
    <div class="card shadow-sm h-100">
      <div class="card-header py-2">
        <strong>Fechas y odómetro</strong>
      </div>
      <div class="card-body small">
        <dl class="row mb-0">
          <dt class="col-5">Fecha salida</dt>
          <dd class="col-7">
            {% if viaje.fecha_salida %}
              {{ viaje.fecha_salida|date:"d/m/Y" }}
              {% if viaje.hora_salida %}
                – {{ viaje.hora_salida|time:"H:i" }} hs
              {% endif %}
            {% else %}
              <span class="text-muted">-</span>
            {% endif %}
          </dd>

          <dt class="col-5">Fecha regreso</dt>
          <dd class="col-7">
            {% if viaje.fecha_regreso %}
              {{ viaje.fecha_regreso|date:"d/m/Y" }}
              {% if viaje.hora_regreso %}
                – {{ viaje.hora_regreso|time:"H:i" }} hs
              {% endif %}
            {% else %}
              <span class="text-muted">No informado</span>
            {% endif %}
          </dd>

          <dt class="col-5">Odómetro inicial</dt>
          <dd class="col-7">
            {% if viaje.odometro_inicial is not None %}
              {{ viaje.odometro_inicial|intcomma }} km
            {% else %}
              <span class="text-muted">Sin dato</span>
            {% endif %}
          </dd>

          <dt class="col-5">Odómetro final</dt>
          <dd class="col-7">
            {% if viaje.odometro_final is not None %}
              {{ viaje.odometro_final|intcomma }} km
            {% else %}
              <span class="text-muted">Sin dato</span>
            {% endif %}
          </dd>

          <dt class="col-5">Km recorridos</dt>
          <dd class="col-7">
            {% if km_recorridos is not None %}
              <strong>{{ km_recorridos|intcomma }} km</strong>
            {% else %}
              <span class="text-muted">No calculado (falta odómetro)</span>
            {% endif %}
          </dd>
        </dl>
      </div>
    </div>
  </div>
</div>

<!-- Tramos del viaje -->
<div class="card shadow-sm mb-3">
  <div class="card-header py-2 d-flex justify-content-between align-items-center">
    <strong>Tramos del viaje</strong>
    <span class="badge bg-light text-muted border">
      {{ tramos|length }} tramo{{ tramos|length|pluralize:"s" }}
    </span>
  </div>
  <div class="card-body p-0">
    {% if tramos %}
      <div class="table-responsive">
        <table class="table table-sm table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th class="text-center" style="width: 60px;">#</th>
              <th>Origen</th>
              <th>Destino</th>
              <th>Motivo</th>
            </tr>
          </thead>
          <tbody>
            {% for tramo in tramos %}
              <tr>
                <td class="text-center">{{ tramo.orden|default:forloop.counter }}</td>
                <td>{{ tramo.origen|default:"-" }}</td>
                <td>{{ tramo.destino|default:"-" }}</td>
                <td class="text-muted small">
                  {% if tramo.motivo %}
                    {{ tramo.motivo }}
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="p-3 text-muted small">
        No hay tramos cargados para este viaje.
      </div>
    {% endif %}
  </div>
</div>

<!-- Cargas de combustible vinculadas -->
<div class="card shadow-sm">
  <div class="card-header py-2 d-flex justify-content-between align-items-center">
    <strong>Cargas de combustible vinculadas</strong>
    <span class="badge bg-light text-muted border">
      {{ cargas_combustible|length }} registro{{ cargas_combustible|length|pluralize:"s" }}
    </span>
  </div>
  <div class="card-body p-0">
    {% if cargas_combustible %}
      <div class="table-responsive">
        <table class="table table-sm table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th style="width: 130px;">Fecha</th>
              <th>Categoría</th>
              <th>Área</th>
              <th class="text-end" style="width: 130px;">Monto</th>
              <th>Detalle</th>
            </tr>
          </thead>
          <tbody>
            {% for mov in cargas_combustible %}
              <tr>
                <td>
                  {{ mov.fecha_operacion|date:"d/m/Y" }}
                </td>
                <td>{{ mov.categoria|default:"-" }}</td>
                <td>{{ mov.area|default:"-" }}</td>
                <td class="text-end">
                  $ {{ mov.monto|floatformat:2|intcomma }}
                </td>
                <td class="small text-muted">
                  {% if mov.descripcion %}
                    {{ mov.descripcion }}
                  {% else %}
                    <span class="text-muted">Sin descripción</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="p-3 text-muted small">
        No hay movimientos de combustible asociados directamente a este viaje.
      </div>
    {% endif %}
  </div>
</div>

{% endblock %}
