{% extends "finanzas/base.html" %}
{% load humanize finanzas_extras %}

{% block title %}Consumo de combustible – Flota{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
  <div>
    <h1 class="h4 mb-0 fw-bold"><i class="bi bi-fuel-pump text-danger me-2"></i>Consumo de combustible</h1>
    <div class="text-muted small">
      Control de consumo, costos y kilometraje de la flota municipal.
    </div>
  </div>

  <div class="text-end small text-muted bg-light px-3 py-1 rounded border">
    <div>Período analizado</div>
    <div class="fw-bold text-dark">
      {{ fecha_desde|date:"d/m/Y" }} – {{ fecha_hasta|date:"d/m/Y" }}
    </div>
  </div>
</div>

<form method="get" class="card card-body mb-4 shadow-sm border-0">
  <div class="row g-2 align-items-end">
    <div class="col-12 col-md-4 col-lg-3">
      <label class="form-label form-label-sm fw-bold text-muted mb-1">Vehículo</label>
      <select name="vehiculo" class="form-select form-select-sm">
        <option value="">-- Todos los vehículos --</option>
        {% for v in vehiculos %}
          <option value="{{ v.id }}" {% if vehiculo_actual|default:'' == v.id|stringformat:"s" %}selected{% endif %}>
            {{ v.patente|default:"S/P" }} - {{ v.descripcion }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-4 col-lg-3">
      <label class="form-label form-label-sm fw-bold text-muted mb-1">Desde</label>
      <input type="date" name="desde" value="{{ fecha_desde|date:'Y-m-d' }}" class="form-control form-control-sm">
    </div>
    <div class="col-6 col-md-4 col-lg-3">
      <label class="form-label form-label-sm fw-bold text-muted mb-1">Hasta</label>
      <input type="date" name="hasta" value="{{ fecha_hasta|date:'Y-m-d' }}" class="form-control form-control-sm">
    </div>
    <div class="col-12 col-lg-3 d-flex gap-2 justify-content-lg-end">
      <button class="btn btn-dark btn-sm flex-fill flex-lg-grow-0" type="submit">
        <i class="bi bi-filter"></i> Filtrar
      </button>
      <a href="{% url 'finanzas:consumo_combustible' %}" class="btn btn-outline-secondary btn-sm flex-fill flex-lg-grow-0">
        Limpiar
      </a>
    </div>
  </div>
</form>

<div class="row g-3 mb-4">
  <div class="col-12 col-md-4">
    <div class="card border-0 shadow-sm h-100 border-start border-4 border-danger">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-1">
            <span class="text-muted small text-uppercase fw-bold">Gasto Total</span>
            <i class="bi bi-cash-coin text-danger opacity-50 fs-5"></i>
        </div>
        <div class="h2 fw-bold text-dark mb-0">${{ total_combustible|default:0|formato_pesos }}</div>
        <div class="small text-muted mt-1">En combustible cargado</div>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-4">
    <div class="card border-0 shadow-sm h-100 border-start border-4 border-info">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-1">
            <span class="text-muted small text-uppercase fw-bold">Litros Totales</span>
            <i class="bi bi-droplet-half text-info opacity-50 fs-5"></i>
        </div>
        <div class="h2 fw-bold text-dark mb-0">{{ total_litros|default:0|floatformat:1 }} L</div>
        <div class="small text-muted mt-1">Consumo volumétrico</div>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-4">
    <div class="card border-0 shadow-sm h-100 border-start border-4 border-success">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-1">
            <span class="text-muted small text-uppercase fw-bold">Operaciones</span>
            <i class="bi bi-receipt text-success opacity-50 fs-5"></i>
        </div>
        <div class="h2 fw-bold text-dark mb-0">{{ total_viajes|default:0 }}</div>
        <div class="small text-muted mt-1">Cargas registradas</div>
      </div>
    </div>
  </div>
</div>

<div class="card border-0 shadow-sm">
  <div class="card-header bg-white py-3 border-bottom">
    <h6 class="mb-0 fw-bold">Desglose por Vehículo</h6>
  </div>
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="table-light small text-uppercase text-muted">
        <tr>
          <th class="ps-4">Vehículo</th>
          <th class="text-end">Cargas</th>
          <th class="text-end">Litros</th>
          <th class="text-end pe-4">Total ($)</th>
        </tr>
      </thead>
      <tbody>
        {% for item in resumen_vehiculos %}
          <tr>
            <td class="ps-4">
                <div class="fw-bold text-dark">{{ item.vehiculo.descripcion }}</div>
                <div class="small text-muted font-monospace">{{ item.vehiculo.patente|default:"S/P" }}</div>
            </td>
            <td class="text-end">{{ item.total_viajes }}</td>
            <td class="text-end">{{ item.total_litros|floatformat:1 }} L</td>
            <td class="text-end pe-4 fw-bold text-danger">${{ item.total_combustible|formato_pesos }}</td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="4" class="text-center py-5 text-muted">
                <i class="bi bi-inbox fs-1 d-block mb-2 opacity-25"></i>
                No hay registros de combustible en este período.
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}