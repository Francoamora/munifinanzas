{% extends "finanzas/base.html" %}
{% load humanize %}
{% load static %}

{% block title %}OP #{{ orden.numero }}{% endblock %}

{% block content %}

<div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4 print-hide animate-fade-in gap-3">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0 small">
                <li class="breadcrumb-item"><a href="{% url 'finanzas:orden_pago_list' %}" class="text-decoration-none text-secondary fw-bold">Tesorería</a></li>
                <li class="breadcrumb-item active">Detalle OP</li>
            </ol>
        </nav>
        <div class="d-flex align-items-center gap-2 mt-1">
            <h1 class="h4 fw-bold text-dark mb-0">Orden de Pago #{{ orden.numero }}</h1>
            {% if orden.estado == 'BORRADOR' %}
                <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle">BORRADOR</span>
            {% elif orden.estado == 'AUTORIZADA' %}
                <span class="badge bg-primary-subtle text-primary border border-primary-subtle">AUTORIZADA</span>
            {% elif orden.estado == 'PAGADA' %}
                <span class="badge bg-success text-white">PAGADA</span>
            {% elif orden.estado == 'ANULADA' %}
                <span class="badge bg-danger text-white">ANULADA</span>
            {% endif %}
        </div>
    </div>

    <div class="d-flex gap-2">
        
        <a href="https://wa.me/?text=Hola, le informamos que la *Orden de Pago N° {{ orden.numero }}* a favor de *{{ orden.proveedor_nombre|urlencode }}* por ${{ orden.total_monto|intcomma }} se encuentra lista/procesada." 
           target="_blank" 
           class="btn btn-success shadow-sm fw-bold text-white hover-lift"
           title="Avisar pago por WhatsApp">
            <i class="bi bi-whatsapp me-2"></i>Avisar
        </a>
        <button onclick="window.print()" class="btn btn-dark shadow-sm fw-bold hover-lift">
            <i class="bi bi-printer-fill me-2"></i>Imprimir
        </button>

        {% if orden.estado == 'BORRADOR' %}
            <a href="{% url 'finanzas:orden_pago_update' orden.pk %}" class="btn btn-white border shadow-sm fw-bold text-secondary hover-lift">
                <i class="bi bi-pencil-square me-2"></i>Editar
            </a>
            {% if rol_staff_finanzas %}
            <form method="post" action="{% url 'finanzas:orden_pago_cambiar_estado' orden.pk 'autorizar' %}" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-success shadow-sm fw-bold hover-lift" onclick="return confirm('¿Autorizar esta Orden de Pago?');">
                    <i class="bi bi-check-lg me-2"></i>Autorizar
                </button>
            </form>
            {% endif %}
        {% endif %}

        {% if orden.estado == 'AUTORIZADA' and rol_staff_finanzas %}
            <form method="post" action="{% url 'finanzas:orden_pago_cambiar_estado' orden.pk 'pagar' %}" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary shadow-sm fw-bold hover-lift" onclick="return confirm('¿Confirmar el pago efectivo sin generar movimiento automático? (Usar solo si ya se descargó caja)');">
                    <i class="bi bi-check2-all me-2"></i>Marcar Pagada
                </button>
            </form>
            <form method="post" action="{% url 'finanzas:orden_pago_cambiar_estado' orden.pk 'anular' %}" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-danger shadow-sm border-0" onclick="return confirm('¿Anular esta orden?');">
                    <i class="bi bi-x-circle"></i>
                </button>
            </form>
        {% endif %}
    </div>
</div>

<div class="card border border-dark rounded-0 bg-white mx-auto shadow-lg" style="max-width: 210mm; min-height: 260mm;" id="printableArea">
    
    <div class="card-body p-5 position-relative">
        
        <div class="row border-bottom border-2 border-dark pb-3 mb-4 align-items-center">
            <div class="col-2 text-center">
                <img src="{% static 'finanzas/img/logo-comuna.png' %}" alt="Logo" style="max-width: 80px; height: auto;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <i class="bi bi-building fs-1 text-secondary" style="display: none;"></i>
            </div>
            <div class="col-6 border-end border-dark">
                <h4 class="fw-bold text-dark mb-0 lh-1">COMUNA DE TACUARENDÍ</h4>
                <div class="small text-muted mt-1">Santa Fe, Argentina</div>
                <div class="small text-muted mb-1">CUIT: 30-67433889-5</div>
                <span class="badge bg-dark text-white rounded-0 text-uppercase ls-1" style="font-size: 0.65rem;">Tesorería General</span>
            </div>
            <div class="col-4 text-end">
                <div class="text-uppercase small fw-bold text-muted mb-1">ORDEN DE PAGO</div>
                <div class="display-6 fw-bold text-dark font-monospace lh-1">{{ orden.numero }}</div>
                <div class="small mt-2 font-monospace">Fecha: <strong>{{ orden.fecha_orden|date:"d/m/Y" }}</strong></div>
            </div>
        </div>

        <div class="row mb-4 g-0">
            <div class="col-7">
                <div class="border border-dark p-3 bg-light bg-opacity-25 h-100 position-relative">
                    <span class="position-absolute top-0 start-0 bg-dark text-white px-2 py-0 small fw-bold text-uppercase" style="font-size: 0.65rem;">Beneficiario</span>
                    <div class="mt-2">
                        <div class="fs-5 fw-bold text-dark text-uppercase">{{ orden.proveedor_nombre }}</div>
                        {% if orden.proveedor_cuit %}
                            <div class="small font-monospace text-muted">CUIT: {{ orden.proveedor_cuit }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-5">
                <div class="border border-dark border-start-0 p-3 h-100 position-relative">
                    <span class="position-absolute top-0 start-0 bg-white border-bottom border-end border-dark px-2 py-0 small fw-bold text-uppercase text-muted" style="font-size: 0.65rem;">Condiciones</span>
                    <div class="mt-1">
                        <ul class="list-unstyled small mb-0">
                            <li class="mb-1 d-flex justify-content-between border-bottom border-dark border-opacity-10 pb-1">
                                <span class="text-muted">Forma de Pago:</span>
                                <span class="fw-bold text-dark text-end">{{ orden.get_condicion_pago_display|default:"A Convenir" }}</span>
                            </li>
                            <li class="mb-1 d-flex justify-content-between border-bottom border-dark border-opacity-10 pb-1">
                                <span class="text-muted">Medio Previsto:</span>
                                <span class="fw-bold text-dark text-end">{{ orden.get_medio_pago_previsto_display|default:"Efec/Transf" }}</span>
                            </li>
                            <li class="d-flex justify-content-between pt-1">
                                <span class="text-muted">Área:</span>
                                <span class="fw-bold text-dark text-end">{{ orden.area|default:"Central" }}</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        {% if orden.factura_numero %}
        <div class="mb-4">
            <div class="bg-light border border-dark border-bottom-0 px-3 py-1 fw-bold text-uppercase small d-flex justify-content-between align-items-center">
                <span><i class="bi bi-receipt me-2"></i>Comprobante Asociado</span>
            </div>
            <table class="table table-bordered border-dark mb-0 table-sm">
                <thead class="bg-white text-center small text-uppercase">
                    <tr>
                        <th style="width: 20%;">Tipo</th>
                        <th style="width: 40%;">Número</th>
                        <th style="width: 20%;">Fecha Emisión</th>
                        <th style="width: 20%;">Importe Comp.</th>
                    </tr>
                </thead>
                <tbody class="align-middle text-center">
                    <tr>
                        <td class="fw-bold">{{ orden.factura_tipo|default:"-" }}</td>
                        <td class="font-monospace">{{ orden.factura_numero }}</td>
                        <td>{{ orden.factura_fecha|date:"d/m/Y"|default:"-" }}</td>
                        <td class="font-monospace">${{ orden.factura_monto|intcomma|default:"-" }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
        {% endif %}

        <div class="mb-4">
            <div class="bg-dark text-white px-3 py-1 fw-bold text-uppercase small mb-0">
                Imputación Presupuestaria / Detalle
            </div>
            <table class="table table-bordered border-dark mb-0 table-sm" style="font-size: 0.95rem;">
                <thead class="bg-light text-center text-uppercase small">
                    <tr>
                        <th style="width: 30%;">Categoría</th>
                        <th style="width: 50%;">Descripción</th>
                        <th style="width: 20%;">Importe</th>
                    </tr>
                </thead>
                <tbody class="align-middle">
                    {% for linea in orden.lineas.all %}
                    <tr>
                        <td class="ps-3 small text-muted">{{ linea.categoria.nombre|default:"General" }}</td>
                        <td class="ps-3 fw-medium text-dark">{{ linea.descripcion }}</td>
                        <td class="text-end pe-3 font-monospace fw-bold">${{ linea.monto|intcomma }}</td>
                    </tr>
                    {% empty %}
                        {% if orden.factura_monto and orden.factura_monto > 0 %}
                        <tr>
                            <td class="ps-3 small text-muted">General / Automático</td>
                            <td class="ps-3 fw-medium text-dark fst-italic">Imputación global según comprobante {{ orden.factura_numero }}</td>
                            <td class="text-end pe-3 font-monospace fw-bold">${{ orden.factura_monto|intcomma }}</td>
                        </tr>
                        {% else %}
                        <tr style="height: 40px;"><td colspan="3"></td></tr>
                        {% endif %}
                    {% endfor %}
                    
                    {% if orden.lineas.count < 3 %}
                        <tr style="height: 30px;"><td class="bg-light opacity-10"></td><td></td><td></td></tr>
                        <tr style="height: 30px;"><td class="bg-light opacity-10"></td><td></td><td></td></tr>
                    {% endif %}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="2" class="text-end fw-bold text-uppercase pe-3 bg-light border-top-2 border-dark align-middle">Total a Pagar</td>
                        <td class="text-end fw-bold bg-light pe-3 fs-5 font-monospace border-top-2 border-dark text-dark">
                            {% if orden.total_monto > 0 %}
                                ${{ orden.total_monto|intcomma }}
                            {% else %}
                                ${{ orden.factura_monto|default:0|intcomma }}
                            {% endif %}
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="mb-5">
            <div class="bg-light border border-dark px-3 py-1 fw-bold text-uppercase small">
                Observaciones / Instrucciones de Pago
            </div>
            <div class="border border-dark border-top-0 p-3" style="min-height: 60px;">
                <p class="mb-0 small text-dark fst-italic">
                    {{ orden.observaciones|default:"Sin observaciones adicionales."|linebreaksbr }}
                </p>
            </div>
        </div>

        <div class="row mt-auto pt-5 align-items-end justify-content-center">
            <div class="col-12 text-center small text-muted border-top pt-2">
                Documento de gestión interna generado el {{ orden.fecha_orden|date:"d/m/Y" }} por el sistema.
            </div>
        </div>

        {% if orden.estado == 'ANULADA' %}
        <div class="position-absolute top-50 start-50 translate-middle text-danger opacity-25" 
             style="transform: translate(-50%, -50%) rotate(-45deg); font-size: 8rem; font-weight: 900; z-index: 0; pointer-events: none; border: 10px solid currentColor; padding: 20px;">
            ANULADA
        </div>
        {% elif orden.estado == 'PAGADA' %}
        <div class="position-absolute top-50 start-50 translate-middle text-success opacity-10" 
             style="transform: translate(-50%, -50%) rotate(-45deg); font-size: 6rem; font-weight: 900; z-index: 0; pointer-events: none; border: 8px solid currentColor; padding: 20px;">
            PAGADA
        </div>
        {% endif %}

    </div>
</div>

{% if orden.estado == 'PAGADA' or orden.estado == 'AUTORIZADA' %}
<div class="container print-hide mb-5" style="max-width: 210mm;">
    <div class="card border-0 shadow-sm rounded-3">
        <div class="card-header bg-white py-2 border-bottom">
            <small class="fw-bold text-uppercase text-muted ls-1"><i class="bi bi-activity me-1"></i>Seguimiento Contable</small>
        </div>
        <div class="card-body">
            {% if movimientos %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0 align-middle">
                        <thead class="bg-light text-secondary small text-uppercase">
                            <tr>
                                <th>Fecha</th>
                                <th>Movimiento</th>
                                <th>Monto</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for m in movimientos %}
                            <tr>
                                <td>{{ m.fecha_operacion|date:"d/m/Y" }}</td>
                                <td>
                                    <a href="{% url 'finanzas:movimiento_detail' m.pk %}" class="text-decoration-none fw-bold text-dark">
                                        #{{ m.id }} - {{ m.descripcion }}
                                    </a>
                                </td>
                                <td class="text-danger fw-bold">-${{ m.monto|intcomma }}</td>
                                <td>
                                    <span class="badge bg-success-subtle text-success border border-success-subtle">{{ m.get_estado_display }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="d-flex align-items-center justify-content-between p-2">
                    <div class="d-flex align-items-center gap-2 text-warning-emphasis">
                        <i class="bi bi-exclamation-circle-fill fs-5"></i>
                        <span>Atención: Esta orden está autorizada pero no se ha descargado el pago de la Caja.</span>
                    </div>
                    {% if rol_staff_finanzas and orden.estado != 'ANULADA' %}
                    <form method="post" action="{% url 'finanzas:orden_pago_generar_movimiento' orden.pk %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-primary btn-sm fw-bold shadow-sm" onclick="return confirm('Se generará un EGRESO en la caja por el total de la orden. ¿Confirmar?');">
                            <i class="bi bi-box-arrow-down me-1"></i>Generar Egreso de Caja
                        </button>
                    </form>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<style>
    /* Estilos Impresión PRO - OCULTAR TODO */
    @media print {
        /* 1. Ocultar TODO por defecto y bloquear scroll */
        html, body {
            margin: 0 !important;
            padding: 0 !important;
            height: 100%;
            overflow: hidden; 
        }

        body * {
            visibility: hidden; 
            height: 0; 
        }

        /* 2. Ocultar Bootstrap intrusivo */
        .navbar, nav, header, footer, .btn, .breadcrumb, .alert {
            display: none !important;
        }

        /* 3. Hacer visible SOLO nuestra hoja A4 */
        #printableArea, #printableArea * {
            visibility: visible;
            height: auto;
            overflow: visible;
        }

        /* 4. Posicionar la hoja A4 cubriendo todo */
        #printableArea {
            position: absolute;
            left: 0;
            top: 0;
            width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            border: none !important;
            box-shadow: none !important;
            background-color: white !important;
            min-height: auto !important; /* Dejar que el contenido mande */
            z-index: 9999;
        }

        /* 5. Ajustes de la hoja real */
        @page {
            size: A4;
            margin: 10mm; /* Margen físico de la impresora */
        }
        
        .bg-dark { background-color: #212529 !important; color: white !important; -webkit-print-color-adjust: exact; }
        .bg-light { background-color: #f8f9fa !important; -webkit-print-color-adjust: exact; }
        
        tr { page-break-inside: avoid; }
    }
    
    .font-monospace { font-family: 'Consolas', 'Monaco', 'Courier New', monospace; letter-spacing: -0.5px; }
    .ls-1 { letter-spacing: 1px; }
    .hover-lift { transition: transform 0.2s; }
    .hover-lift:hover { transform: translateY(-2px); }
</style>

{% endblock %}