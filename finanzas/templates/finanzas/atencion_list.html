{% extends "finanzas/base.html" %}
{% load humanize %}

{% block title %}Atenciones{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4">
  <div>
    <h1 class="h3 fw-bold text-dark mb-1">Atenciones</h1>
    <div class="text-muted small">Listado general (con filtros).</div>
  </div>
  <a href="{% url 'finanzas:atencion_create' %}" class="btn btn-primary shadow-sm">
    <i class="bi bi-plus-lg me-1"></i> Nueva Atención
  </a>
</div>

<div class="card border-0 shadow-sm rounded-4 overflow-hidden mb-4">
  <div class="card-body p-3 p-md-4">
    <form class="row g-2 align-items-end" method="get">
      <div class="col-12 col-md-5">
        <label class="form-label small text-muted mb-1">Buscar</label>
        <input type="text" class="form-control" name="q" value="{{ q }}" placeholder="Apellido, nombre, DNI, descripción…">
      </div>
      <div class="col-12 col-md-4">
        <label class="form-label small text-muted mb-1">Área</label>
        <select class="form-select" name="area">
          <option value="">Todas</option>
          {% for a in filtros_areas %}
            <option value="{{ a.id }}" {% if area_sel == a.id|stringformat:"s" %}selected{% endif %}>{{ a.nombre }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-12 col-md-3">
        <label class="form-label small text-muted mb-1">Estado</label>
        <select class="form-select" name="estado">
          <option value="">Todos</option>
          {% for val,label in estado_choices %}
            <option value="{{ val }}" {% if estado_sel == val %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-12 d-flex gap-2 justify-content-end mt-2">
        <a class="btn btn-light" href="{% url 'finanzas:atencion_list' %}">Limpiar</a>
        <button class="btn btn-dark" type="submit">Filtrar</button>
      </div>
    </form>
  </div>
</div>

<div class="card border-0 shadow-sm rounded-4 overflow-hidden">
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="bg-light small text-uppercase text-muted">
        <tr>
          <th class="ps-4">Fecha</th>
          <th>Persona</th>
          <th>Área</th>
          <th>Motivo</th>
          <th>Estado</th>
          <th class="text-end pe-4">Acción</th>
        </tr>
      </thead>
      <tbody>
        {% for a in atenciones %}
        <tr>
          <td class="ps-4">
            <div class="fw-bold text-dark">{{ a.fecha_atencion|date:"d/m/Y" }}</div>
            <div class="small text-muted">#{{ a.id }}</div>
          </td>
          <td>
            {% if a.persona %}
              <a class="text-decoration-none fw-semibold" href="{% url 'finanzas:persona_detail' a.persona.pk %}">
                {{ a.persona.apellido }}, {{ a.persona.nombre }}
              </a>
              <div class="small text-muted">{{ a.persona.dni }}</div>
            {% else %}
              <div class="fw-semibold text-dark">{{ a.persona_nombre|default:"(Sin nombre)" }}</div>
              <div class="small text-muted">{{ a.persona_dni }}</div>
            {% endif %}
          </td>
          <td>
            <span class="text-dark">{{ a.area|default:"-" }}</span>
          </td>
          <td>
            <span class="badge bg-primary-subtle text-primary border border-primary-subtle">
              {{ a.get_motivo_principal_display }}
            </span>
          </td>
          <td>
            {% if a.estado == "ABIERTA" %}
              <span class="badge bg-success-subtle text-success border border-success-subtle">ABIERTA</span>
            {% elif a.estado == "EN_SEGUIMIENTO" %}
              <span class="badge bg-warning-subtle text-warning border border-warning-subtle">SEGUIMIENTO</span>
            {% else %}
              <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle">CERRADA</span>
            {% endif %}
          </td>
          <td class="text-end pe-4">
            <a href="{% url 'finanzas:atencion_update' a.pk %}?next={{ request.get_full_path|urlencode }}"
               class="btn btn-sm btn-outline-secondary">
              Editar <i class="bi bi-chevron-right ms-1"></i>
            </a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="text-center py-5">
            <div class="text-muted opacity-50 mb-3"><i class="bi bi-inboxes fs-1"></i></div>
            <p class="mb-0 text-muted">No hay atenciones registradas con esos filtros.</p>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="card-footer bg-white border-top-0 py-3">
    {% include "finanzas/components/pagination.html" %}
  </div>
</div>
{% endblock %}
