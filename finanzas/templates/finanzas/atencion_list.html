{% extends "finanzas/base.html" %}

{% block title %}Atenciones sociales – Comuna de Tacuarendí{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
  <div>
    <h1 class="h4 mb-1">
      Atenciones sociales
    </h1>
    <div class="text-muted small">
      Registro de reclamos, trámites, pensiones y acompañamiento a personas y hogares.
      <br>
      <span class="text-muted">
        Vista social sin montos: enfocada en a quién se atendió, por qué y qué gestión se inició.
      </span>
    </div>
  </div>

  <div class="d-flex flex-wrap gap-2">
    <a href="{% url 'finanzas:persona_list' %}" class="btn btn-outline-secondary btn-sm">
      Personas / censo
    </a>
    <a href="{% url 'finanzas:atencion_create' %}" class="btn btn-primary btn-sm">
      Nueva atención social
    </a>
  </div>
</div>

<div class="card shadow-sm border-0 mb-3">
  <div class="card-body pb-2">
    <form method="get" class="row g-2 align-items-end">
      <div class="col-12 col-md-4">
        <label for="id_q" class="form-label form-label-sm mb-1">
          Buscar por persona / DNI / texto
        </label>
        <input
          type="text"
          name="q"
          id="id_q"
          value="{{ request.GET.q }}"
          class="form-control form-control-sm"
          placeholder="Ej: Pérez, 30123456, pensión, reclamo agua"
        >
      </div>

      <div class="col-12 col-md-4">
        <label for="id_area" class="form-label form-label-sm mb-1">
          Área responsable
        </label>
        <select name="area" id="id_area" class="form-select form-select-sm">
          <option value="">Todas</option>
          {% for a in filtros_areas %}
            <option
              value="{{ a.id }}"
              {% if request.GET.area|stringformat:"s" == a.id|stringformat:"s" %}selected{% endif %}
            >
              {{ a.nombre }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-12 col-md-4">
        <label for="id_estado" class="form-label form-label-sm mb-1">
          Estado
        </label>
        <select name="estado" id="id_estado" class="form-select form-select-sm">
          <option value="">Todos</option>
          {% if filtros_estados %}
            {% for value,label in filtros_estados %}
              <option
                value="{{ value }}"
                {% if request.GET.estado|stringformat:"s" == value|stringformat:"s" %}selected{% endif %}
              >
                {{ label }}
              </option>
            {% endfor %}
          {% endif %}
        </select>
      </div>

      <div class="col-12 d-flex gap-2 justify-content-end mt-1">
        <button type="submit" class="btn btn-primary btn-sm">
          Aplicar filtros
        </button>
        <a href="{% url 'finanzas:atencion_list' %}" class="btn btn-outline-secondary btn-sm">
          Limpiar
        </a>
      </div>
    </form>
  </div>
</div>

<div class="card shadow-sm border-0 mb-3">
  <div class="card-header bg-body border-0 pb-1">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
      <div>
        <h2 class="h6 mb-0">Listado de atenciones sociales</h2>
        <div class="text-muted small">
          Resultados según los filtros aplicados.
        </div>
      </div>
      <div class="text-muted small">
        Total: <strong>{{ total_atenciones|default:0 }}</strong> atenciones
      </div>
    </div>
  </div>

  <div class="card-body pt-2">
    {% if atenciones %}
      <div class="table-responsive">
        <table class="table table-sm table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th class="text-nowrap">Fecha</th>
              <th>Persona / hogar</th>
              <th class="text-nowrap">Trámite / motivo</th>
              <th class="text-nowrap">Canal</th>
              <th>Área</th>
              <th class="text-nowrap">Estado</th>
              <th class="text-nowrap">Seguimiento</th>
              <th class="text-center text-nowrap">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for at in atenciones %}
              <tr>
                <td class="text-nowrap">
                  {% if at.fecha_atencion %}
                    {{ at.fecha_atencion|date:"d/m/Y" }}
                  {% elif at.fecha_operacion %}
                    {{ at.fecha_operacion|date:"d/m/Y" }}
                  {% else %}
                    <span class="text-muted small">Sin fecha</span>
                  {% endif %}
                </td>

                <td>
                  {% if at.persona %}
                    <a
                      href="{% url 'finanzas:persona_detail' at.persona.id %}"
                      class="link-body-emphasis text-decoration-none"
                    >
                      {{ at.persona.apellido }}, {{ at.persona.nombre }}
                    </a>
                    <div class="text-muted small">
                      DNI {{ at.persona.dni|default:"-" }}
                      {% if at.persona.barrio %}
                        · {{ at.persona.barrio }}
                      {% endif %}
                    </div>
                  {% else %}
                    <span class="fw-semibold">
                      {{ at.persona_nombre|default:"(Sin persona asociada)" }}
                    </span>
                    {% if at.persona_dni %}
                      <div class="text-muted small">
                        DNI {{ at.persona_dni }}
                      </div>
                    {% endif %}
                    {% if at.persona_barrio %}
                      <div class="text-muted small">
                        {{ at.persona_barrio }}
                      </div>
                    {% endif %}
                  {% endif %}
                </td>

                <td class="text-nowrap">
                  {% if at.get_motivo_principal_display %}
                    {{ at.get_motivo_principal_display }}
                  {% elif at.motivo_principal %}
                    {{ at.motivo_principal }}
                  {% else %}
                    <span class="text-muted small">Sin motivo</span>
                  {% endif %}
                </td>

                <td class="text-nowrap">
                  {% if at.get_canal_display %}
                    {{ at.get_canal_display }}
                  {% elif at.canal %}
                    {{ at.canal }}
                  {% else %}
                    <span class="text-muted small">Sin canal</span>
                  {% endif %}
                </td>

                <td>
                  {% if at.area %}
                    <span class="small">{{ at.area.nombre|default:at.area }}</span>
                  {% else %}
                    <span class="text-muted small">Sin área</span>
                  {% endif %}
                </td>

                <td class="text-nowrap">
                  {% if at.estado %}
                    <span class="badge
                      {% if at.estado == 'cerrada' %}
                        bg-success-subtle text-success border border-success-subtle
                      {% elif at.estado == 'en_curso' %}
                        bg-warning-subtle text-warning border border-warning-subtle
                      {% else %}
                        bg-secondary-subtle text-secondary border border-secondary-subtle
                      {% endif %}
                    ">
                      {{ at.get_estado_display|default:at.estado }}
                    </span>
                  {% else %}
                    <span class="text-muted small">Sin estado</span>
                  {% endif %}
                </td>

                <td class="text-nowrap">
                  {% if at.requiere_seguimiento %}
                    <span class="badge bg-warning-subtle text-warning border border-warning-subtle">
                      Requiere seguimiento
                    </span>
                  {% elif at.tarea_seguimiento %}
                    <span class="badge bg-info-subtle text-info border border-info-subtle">
                      Seguimiento agendado
                    </span>
                  {% else %}
                    <span class="text-muted small">Sin seguimiento</span>
                  {% endif %}
                </td>

                <td class="text-center">
                  {% if at.persona %}
                    <a
                      href="{% url 'finanzas:persona_detail' at.persona.id %}"
                      class="btn btn-outline-primary btn-sm me-1"
                    >
                      Ver persona
                    </a>
                    <a
                      href="{% url 'finanzas:atencion_beneficiario_list' at.persona.id %}"
                      class="btn btn-outline-secondary btn-sm"
                    >
                      Ver atenciones
                    </a>
                  {% else %}
                    <span class="text-muted small">—</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if is_paginated %}
        <div class="d-flex justify-content-between align-items-center mt-3">
          <div class="text-muted small">
            Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
          </div>
          <nav>
            <ul class="pagination pagination-sm mb-0">
              {% if page_obj.has_previous %}
                <li class="page-item">
                  <a
                    class="page-link"
                    href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.area %}&area={{ request.GET.area }}{% endif %}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}"
                  >
                    Anterior
                  </a>
                </li>
              {% else %}
                <li class="page-item disabled">
                  <span class="page-link">Anterior</span>
                </li>
              {% endif %}

              <li class="page-item active">
                <span class="page-link">
                  {{ page_obj.number }}
                </span>
              </li>

              {% if page_obj.has_next %}
                <li class="page-item">
                  <a
                    class="page-link"
                    href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.area %}&area={{ request.GET.area }}{% endif %}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}"
                  >
                    Siguiente
                  </a>
                </li>
              {% else %}
                <li class="page-item disabled">
                  <span class="page-link">Siguiente</span>
                </li>
              {% endif %}
            </ul>
          </nav>
        </div>
      {% endif %}
    {% else %}
      <div class="text-center py-4">
        <div class="mb-2">
          <i class="bi bi-people text-muted" style="font-size: 1.8rem;"></i>
        </div>
        <p class="mb-1">
          Todavía no se registraron atenciones sociales con los filtros actuales.
        </p>
        <p class="text-muted small mb-3">
          Probá buscar por otra persona, cambiar el área o el estado.
        </p>
        <a href="{% url 'finanzas:atencion_create' %}" class="btn btn-primary btn-sm">
          Cargar primera atención social
        </a>
      </div>
    {% endif %}
  </div>
</div>

{% endblock %}
