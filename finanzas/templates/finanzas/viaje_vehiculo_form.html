{% extends "finanzas/base.html" %}
{% load static %}

{% block title %}
  {% if viaje and viaje.pk %}
    Editar viaje de vehículo – Flota
  {% else %}
    Nuevo viaje de vehículo – Flota
  {% endif %}
{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
  <div>
    <p class="text-muted small mb-1 d-flex flex-wrap align-items-center gap-2">
      <span>Flota y combustible</span>
      <span>·</span>
      <span>Registro de viajes y odómetro</span>
    </p>
    <h1 class="h4 mb-1">
      {% if viaje and viaje.pk %}
        Editar viaje de vehículo
      {% else %}
        Nuevo viaje de vehículo
      {% endif %}
    </h1>
    <div class="small text-muted">
      Registrá fechas, odómetro, recorrido y personas trasladadas.
      El sistema puede vincular después los movimientos de combustible.
    </div>
  </div>

  <div class="d-flex flex-column align-items-end gap-2">
    <a href="{% url 'finanzas:viaje_vehiculo_list' %}" class="btn btn-outline-secondary btn-sm">
      Volver al listado
    </a>
    {% if viaje and viaje.pk %}
      <span class="badge bg-light text-muted border small">
        Estado: {{ viaje.get_estado_display }}
      </span>
    {% endif %}
  </div>
</div>

<form method="post" novalidate class="card shadow-sm">
  {% csrf_token %}
  <div class="card-body">

    {% if form.non_field_errors %}
      <div class="alert alert-danger py-2 small">
        {{ form.non_field_errors }}
      </div>
    {% endif %}

    {# ========== BLOQUE 1: VEHÍCULO / RESPONSABLE ========== #}
    <h2 class="h6 text-uppercase text-muted mb-2">Vehículo y responsable</h2>
    <div class="row g-3 mb-3">
      <div class="col-12 col-md-4">
        <label class="form-label mb-1" for="{{ form.vehiculo.id_for_label }}">Vehículo</label>
        {{ form.vehiculo }}
        {% for error in form.vehiculo.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>
      <div class="col-12 col-md-4">
        <label class="form-label mb-1" for="{{ form.area.id_for_label }}">Área responsable</label>
        {{ form.area }}
        {% for error in form.area.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>
      <div class="col-12 col-md-4">
        <label class="form-label mb-1" for="{{ form.tipo_recorrido.id_for_label }}">Tipo de recorrido</label>
        {{ form.tipo_recorrido }}
        {% for error in form.tipo_recorrido.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>

      {# --- Chofer con buscador sobre el censo (select oculto) --- #}
      <div class="col-12 col-md-4">
        <div id="chofer-wrapper" data-chofer-enhanced="1">
          <label class="form-label mb-1">Chofer / responsable (censo)</label>
          <div class="small text-muted mb-1">
            Buscá por <strong>apellido, nombre o DNI</strong> dentro del censo y seleccioná el chofer.
          </div>

          <input
            type="text"
            class="form-control form-control-sm js-chofer-search"
            placeholder="Ej: Pérez Juan, 30123456"
            autocomplete="off"
          >

          <div
            class="list-group list-group-flush small mt-1 js-chofer-results"
            style="max-height: 220px; overflow-y: auto;"
            aria-live="polite">
          </div>

          <div class="mt-2">
            <div class="small text-muted mb-1">Seleccionado</div>
            <div class="border rounded-1 p-2 small bg-light js-chofer-preview" aria-live="polite">
              <span class="text-muted">Ningún chofer seleccionado todavía.</span>
            </div>
          </div>

          <div class="d-none">
            {{ form.chofer }}
          </div>

          {% if form.chofer.errors %}
            <div class="text-danger small mt-1">
              {{ form.chofer.errors|join:", " }}
            </div>
          {% endif %}
        </div>
      </div>

      <div class="col-12 col-md-8">
        <label class="form-label mb-1" for="{{ form.chofer_nombre.id_for_label }}">Chofer (texto libre)</label>
        {{ form.chofer_nombre }}
        {% for error in form.chofer_nombre.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
        <div class="form-text small">
          Usalo si el chofer no está cargado en el censo.
        </div>
      </div>
    </div>

    {# ========== BLOQUE 2: FECHAS / ODÓMETRO / HORÓMETRO ========== #}
    <h2 class="h6 text-uppercase text-muted mb-2">Fechas y odómetro</h2>
    <div class="row g-3 mb-3">
      <div class="col-6 col-md-3">
        <label class="form-label mb-1" for="{{ form.fecha_salida.id_for_label }}">Fecha salida</label>
        {{ form.fecha_salida }}
        {% for error in form.fecha_salida.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>
      <div class="col-6 col-md-3">
        <label class="form-label mb-1" for="{{ form.hora_salida.id_for_label }}">Hora salida</label>
        {{ form.hora_salida }}
        {% for error in form.hora_salida.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>
      <div class="col-6 col-md-3">
        <label class="form-label mb-1" for="{{ form.fecha_regreso.id_for_label }}">Fecha regreso</label>
        {{ form.fecha_regreso }}
        {% for error in form.fecha_regreso.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>
      <div class="col-6 col-md-3">
        <label class="form-label mb-1" for="{{ form.hora_regreso.id_for_label }}">Hora regreso</label>
        {{ form.hora_regreso }}
        {% for error in form.hora_regreso.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>

      <div class="col-6 col-md-3">
        <label class="form-label mb-1" for="{{ form.odometro_inicial.id_for_label }}">Odómetro inicial (km)</label>
        {{ form.odometro_inicial }}
        {% for error in form.odometro_inicial.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>
      <div class="col-6 col-md-3">
        <label class="form-label mb-1" for="{{ form.odometro_final.id_for_label }}">Odómetro final (km)</label>
        {{ form.odometro_final }}
        {% for error in form.odometro_final.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>

      <div class="col-6 col-md-3">
        <label class="form-label mb-1" for="{{ form.horometro_inicial.id_for_label }}">Horómetro inicial</label>
        {{ form.horometro_inicial }}
        {% for error in form.horometro_inicial.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>
      <div class="col-6 col-md-3">
        <label class="form-label mb-1" for="{{ form.horometro_final.id_for_label }}">Horómetro final</label>
        {{ form.horometro_final }}
        {% for error in form.horometro_final.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>

      <div class="col-6 col-md-3">
        <label class="form-label mb-1" for="{{ form.litros_tanque_inicio.id_for_label }}">Litros tanque inicio</label>
        {{ form.litros_tanque_inicio }}
        {% for error in form.litros_tanque_inicio.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>
      <div class="col-6 col-md-3">
        <label class="form-label mb-1" for="{{ form.litros_tanque_fin.id_for_label }}">Litros tanque fin</label>
        {{ form.litros_tanque_fin }}
        {% for error in form.litros_tanque_fin.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>
    </div>

    {# ========== BLOQUE 3: RECORRIDO / MOTIVO ========== #}
    <h2 class="h6 text-uppercase text-muted mb-2">Recorrido general</h2>
    <div class="row g-3 mb-3">
      <div class="col-12 col-md-6">
        <label class="form-label mb-1" for="{{ form.origen.id_for_label }}">Origen</label>
        {{ form.origen }}
        {% for error in form.origen.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>
      <div class="col-12 col-md-6">
        <label class="form-label mb-1" for="{{ form.destino.id_for_label }}">Destino</label>
        {{ form.destino }}
        {% for error in form.destino.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>
      <div class="col-12 col-md-6">
        <label class="form-label mb-1" for="{{ form.motivo.id_for_label }}">Motivo</label>
        {{ form.motivo }}
        {% for error in form.motivo.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>
      <div class="col-12 col-md-6">
        <label class="form-label mb-1" for="{{ form.observaciones.id_for_label }}">Observaciones</label>
        {{ form.observaciones }}
        {% for error in form.observaciones.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>
    </div>

    {# ========== BLOQUE 4: PERSONAS TRASLADADAS ========== #}
    <h2 class="h6 text-uppercase text-muted mb-2">Personas trasladadas</h2>
    <div class="row g-3 mb-3">
      <div class="col-12 col-md-6">
        <div id="beneficiarios-wrapper" data-benef-enhanced="1">
          <label class="form-label mb-1">Beneficiarios (censo)</label>
          <div class="small text-muted mb-1">
            Buscá por <strong>apellido, nombre o DNI</strong> y agregá las personas trasladadas.
          </div>

          <input
            type="text"
            class="form-control form-control-sm js-benef-search"
            placeholder="Ej: Gómez Ana, 12345678"
            autocomplete="off"
          >

          <div
            class="list-group list-group-flush small mt-1 js-benef-results"
            style="max-height: 220px; overflow-y: auto;"
            aria-live="polite">
          </div>

          <div class="mt-2">
            <div class="small text-muted mb-1">Seleccionados</div>
            <div class="js-benef-chips d-flex flex-wrap gap-1" aria-live="polite">
              <span class="text-muted small">Todavía no agregaste personas.</span>
            </div>
          </div>

          <div class="d-none">
            {{ form.beneficiarios }}
          </div>

          {% if form.beneficiarios.errors %}
            <div class="text-danger small mt-1">
              {{ form.beneficiarios.errors|join:", " }}
            </div>
          {% endif %}

          <div class="form-text small mt-1">
            Seleccioná personas individuales que fueron trasladadas en este viaje.
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6">
        <label class="form-label mb-1" for="{{ form.otros_beneficiarios.id_for_label }}">Otros beneficiarios (texto libre)</label>
        {{ form.otros_beneficiarios }}
        {% for error in form.otros_beneficiarios.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
        <div class="form-text small">
          Ej: “Familia Pérez”, “Delegación club X”, etc.
        </div>
      </div>
    </div>

    {# ========== BLOQUE 5: COMBUSTIBLE ASOCIADO ========== #}
    <div class="d-flex justify-content-between align-items-center mb-1">
      <h2 class="h6 text-uppercase text-muted mb-0">Combustible asociado</h2>
      <span class="badge bg-light text-muted border small">
        Opcional · movimientos de combustible aprobados
      </span>
    </div>
    <p class="text-muted small mb-2">
      Podés vincular las cargas de combustible (movimientos) que correspondan a este viaje.
      El formulario sugiere por vehículo y fecha, pero siempre lo podés ajustar.
    </p>
    <div class="row g-3 mb-3">
      <div class="col-12 col-md-8">
        {{ form.cargas_combustible }}
        {% for error in form.cargas_combustible.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>
      <div class="col-12 col-md-4">
        <label class="form-label mb-1" for="{{ form.estado.id_for_label }}">Estado del viaje</label>
        {{ form.estado }}
        {% for error in form.estado.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
        <div class="form-text small">
          Usá <strong>Cerrado</strong> cuando el viaje esté completo y con odómetro final.
        </div>
      </div>
    </div>

    {# ========== BLOQUE 6: TRAMOS DEL VIAJE (FORMSET) ========== #}
    <hr class="my-4">

    <div class="d-flex justify-content-between align-items-center mb-1">
      <h2 class="h6 text-uppercase text-muted mb-0">Tramos del viaje (detalle opcional)</h2>
      <span class="badge bg-light text-muted border small">
        Opcional · desglosa el recorrido en tramos
      </span>
    </div>
    <p class="text-muted small mb-2">
      El recorrido general se define arriba (origen/destino principal).
      Acá podés desglosar en tramos cuando necesites mayor detalle
      (ej: Tacuarendí → Las Toscas → Reconquista). Si no, dejá esta sección en blanco.
    </p>

    {% if tramos_formset.non_form_errors %}
      <div class="alert alert-danger py-2 small">
        {{ tramos_formset.non_form_errors }}
      </div>
    {% endif %}

    <div class="table-responsive">
      <table class="table table-sm align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="width: 60px;">#</th>
            <th>Origen</th>
            <th>Destino</th>
            <th>Salida</th>
            <th>Llegada</th>
            <th>Motivo</th>
            <th>Notas</th>
            <th class="text-center" style="width: 60px;">Borrar</th>
          </tr>
        </thead>
        <tbody>
          {{ tramos_formset.management_form }}
          {% for tform in tramos_formset %}
            <tr>
              {# Campos ocultos (id, etc.) #}
              {% for hidden in tform.hidden_fields %}
                {{ hidden }}
              {% endfor %}

              <td>
                {{ tform.orden }}
                {% for error in tform.orden.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </td>
              <td>
                {{ tform.origen }}
                {% for error in tform.origen.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </td>
              <td>
                {{ tform.destino }}
                {% for error in tform.destino.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </td>
              <td>
                {{ tform.hora_salida }}
                {% for error in tform.hora_salida.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </td>
              <td>
                {{ tform.hora_llegada }}
                {% for error in tform.hora_llegada.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </td>
              <td>
                {{ tform.motivo }}
                {% for error in tform.motivo.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </td>
              <td>
                {{ tform.observaciones }}
                {% for error in tform.observaciones.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </td>
              <td class="text-center">
                {% if tform.DELETE %}
                  {{ tform.DELETE }}
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>

  <div class="card-footer d-flex justify-content-between align-items-center flex-wrap gap-2">
    <div class="small text-muted">
      Los campos marcados con <span class="text-danger">*</span> en el formulario son obligatorios.
    </div>
    <div class="d-flex flex-wrap gap-2">
      <a href="{% url 'finanzas:viaje_vehiculo_list' %}" class="btn btn-outline-secondary btn-sm">
        Cancelar
      </a>
      <button type="submit" class="btn btn-primary btn-sm">
        {% if viaje and viaje.pk %}Guardar cambios{% else %}Guardar viaje{% endif %}
      </button>
    </div>
  </div>
</form>

{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script src="{% static 'finanzas/js/viaje_vehiculo_form.js' %}"></script>
{% endblock %}
