{% extends "finanzas/base.html" %}
{% load static %}
{% load humanize %}

{% block title %}
  {% if form.instance.pk %}Editar Operación{% else %}Nueva Operación{% endif %}
{% endblock %}

{% block content %}

<div class="row justify-content-center animate-fade-in" style="padding-bottom: 140px;">
  <div class="col-12 col-xl-9">

    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1 class="h3 fw-bold text-dark mb-1">
          {% if form.instance.pk %}
            <i class="bi bi-pencil-square me-2 text-primary"></i>Editar Operación
          {% else %}
            <i class="bi bi-plus-circle-fill me-2 text-primary"></i>Registrar Operación
          {% endif %}
        </h1>
        <p class="text-secondary mb-0 fw-medium small">
          Gestión de Caja. <span class="text-danger">* Obligatorio.</span>
        </p>
      </div>
      <a href="{% url 'finanzas:movimiento_list' %}" class="btn btn-white border shadow-sm btn-sm px-4 fw-bold text-secondary hover-lift">
        <i class="bi bi-x-lg me-1"></i> Cancelar
      </a>
    </div>

    {% if form.instance.pk and form.instance.esta_aprobado %}
      <div class="alert alert-warning border-0 shadow-sm d-flex align-items-center mb-4 rounded-3 text-dark">
        <i class="bi bi-lock-fill fs-4 me-3 text-warning-emphasis"></i>
        <div>
          <strong class="text-warning-emphasis">Operación Cerrada.</strong> Ya impactó en caja.
        </div>
      </div>
    {% endif %}

    <form method="post" class="needs-validation form-pro" novalidate id="movimientoForm" 
          data-categorias-url="{% url 'finanzas:categorias_por_tipo' %}">
      {% csrf_token %}

      {% if form.errors %}
        <div class="alert alert-danger border-0 shadow-sm mb-4 rounded-3">
          <div class="d-flex align-items-start gap-3">
            <i class="bi bi-exclamation-triangle-fill fs-4 text-danger"></i>
            <div>
              <div class="fw-bold text-danger">Atención</div>
              <ul class="mb-0 small text-danger-emphasis ps-3">
                {% for field in form %}
                  {% if field.errors %}<li><strong>{{ field.label }}:</strong> {{ field.errors|striptags }}</li>{% endif %}
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>
      {% endif %}

      <div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden">
        <div class="card-body p-4 p-lg-5">
          <h6 class="text-uppercase text-primary fw-bold mb-4 ls-1 border-bottom pb-2">
            <i class="bi bi-wallet2 me-2"></i>Datos Financieros
          </h6>
          
          <div class="row g-4">
            <div class="col-md-4">
                <label class="form-label small fw-bold text-secondary">TIPO OPERACIÓN *</label>
                {{ form.tipo }}
            </div>
            <div class="col-md-4">
                <label class="form-label small fw-bold text-secondary">FECHA *</label>
                <div class="input-group">
                    <span class="input-group-text bg-light border-end-0"><i class="bi bi-calendar-event text-muted"></i></span>
                    {{ form.fecha_operacion }}
                </div>
            </div>
            <div class="col-md-4">
                <label class="form-label small fw-bold text-success">MONTO TOTAL *</label>
                <div class="input-group">
                    <span class="input-group-text bg-success-subtle text-success border-success-subtle fw-bold">$</span>
                    {{ form.monto }}
                </div>
            </div>

            <div class="col-12"><hr class="border-light m-0"></div>

            <div class="col-md-6">
                <label class="form-label small fw-bold text-secondary">CATEGORÍA / RUBRO *</label>
                <div class="position-relative">
                    <select name="{{ form.categoria.name }}" id="id_categoria" class="form-select no-select2" required>
                        <option value="">---------</option>
                        {% if form.instance.pk and form.instance.categoria %}
                            <option value="{{ form.instance.categoria.id }}" selected 
                                    data-ayuda="{{ form.instance.categoria.es_ayuda_social|yesno:'true,false' }}"
                                    data-combustible="{{ form.instance.categoria.es_combustible|yesno:'true,false' }}">
                                {{ form.instance.categoria.nombre }}
                            </option>
                        {% endif %}
                    </select>
                    <div id="catLoading" class="position-absolute top-50 end-0 translate-middle-y me-4 d-none">
                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                    </div>
                </div>
                <div class="mt-2 d-flex align-items-center">
                    <span id="catBadge" class="badge bg-secondary d-none"></span>
                </div>
            </div>

            <div class="col-md-6">
                <label class="form-label small fw-bold text-secondary">ÁREA SOLICITANTE</label>
                {{ form.area }}
            </div>

            <div class="col-md-6" id="cuentaOrigenWrap">
                <label class="form-label small fw-bold text-secondary">CUENTA ORIGEN</label>
                {{ form.cuenta_origen_texto }}
            </div>
            <div class="col-md-6" id="cuentaDestinoWrap">
                <label class="form-label small fw-bold text-secondary">CUENTA DESTINO</label>
                {{ form.cuenta_destino_texto }}
            </div>

            <div class="col-12">
                <label class="form-label small fw-bold text-secondary">DESCRIPCIÓN PÚBLICA *</label>
                {{ form.descripcion }}
            </div>
          </div>
        </div>
      </div>

      <div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden" id="personaCard">
        <div class="card-body p-4 p-lg-5">
          <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
             <h6 class="text-uppercase text-indigo fw-bold mb-0 ls-1"><i class="bi bi-person-badge me-2"></i>Persona Vinculada</h6>
             <span class="badge bg-light text-secondary border" id="personaBadge">Opcional</span>
          </div>
          <div class="row g-3">
            <div class="col-12">
                <label class="form-label small fw-bold text-dark">BUSCAR EN PADRÓN</label>
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-primary"></i></span>
                    {{ form.beneficiario }}
                </div>
            </div>
            <div class="col-md-8">
                <label class="form-label small fw-bold text-muted" style="font-size:0.7rem;">NOMBRE</label>
                {{ form.beneficiario_nombre }}
            </div>
            <div class="col-md-4">
                <label class="form-label small fw-bold text-muted" style="font-size:0.7rem;">DNI</label>
                {{ form.beneficiario_dni }}
            </div>
            
            <div class="col-12 mt-3">
                <button class="btn btn-sm btn-outline-primary w-100 fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#personaNuevaBox">
                    <i class="bi bi-person-plus-fill me-1"></i>Cargar Persona Nueva (Express)
                </button>
                <div id="personaNuevaBox" class="collapse mt-2">
                    <div class="card card-body bg-light border-0">
                        <div class="row g-2">
                            <div class="col-md-3"><label class="small text-muted">DNI</label>{{ form.persona_nueva_dni }}</div>
                            <div class="col-md-5"><label class="small text-muted">Apellidos</label>{{ form.persona_nueva_apellido }}</div>
                            <div class="col-md-4"><label class="small text-muted">Nombres</label>{{ form.persona_nueva_nombre }}</div>
                        </div>
                    </div>
                </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden" id="assignCard">
        <div class="card-header bg-white p-0 border-bottom">
          <ul class="nav nav-tabs nav-justified border-0" id="assignTab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active py-3 text-uppercase" id="proveedor-tab" data-bs-toggle="tab" data-bs-target="#proveedor-pane" type="button">
                    <i class="bi bi-shop me-2"></i>Proveedor
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link py-3 text-uppercase" id="ayuda-tab" data-bs-toggle="tab" data-bs-target="#ayuda-pane" type="button">
                    <i class="bi bi-heart me-2"></i>Ayuda Social
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link py-3 text-uppercase" id="vehiculo-tab" data-bs-toggle="tab" data-bs-target="#vehiculo-pane" type="button">
                    <i class="bi bi-fuel-pump me-2"></i>Combustible
                </button>
            </li>
          </ul>
        </div>
        <div class="card-body p-4 bg-light bg-opacity-25">
          <div class="tab-content">
            
            <div class="tab-pane fade show active" id="proveedor-pane">
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label small fw-bold text-dark">BUSCAR PROVEEDOR</label>
                        {{ form.proveedor }}
                    </div>
                    <div class="col-md-8">
                        <label class="form-label small fw-bold text-muted">RAZÓN SOCIAL</label>
                        {{ form.proveedor_nombre }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small fw-bold text-muted">CUIT</label>
                        {{ form.proveedor_cuit }}
                    </div>

                    <div class="col-12 mt-3">
                        <button class="btn btn-sm btn-outline-primary w-100 fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#provNuevoBox">
                            <i class="bi bi-shop me-1"></i>Cargar Proveedor Nuevo (Express)
                        </button>
                        <div id="provNuevoBox" class="collapse mt-2">
                            <div class="card card-body bg-light border-0">
                                <div class="row g-2 align-items-end">
                                    <div class="col-md-5">
                                        <label class="small text-muted">Razón Social *</label>
                                        <input type="text" id="new_prov_nombre" class="form-control" placeholder="Ej: Ferretería El Norte">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="small text-muted">CUIT (Opcional)</label>
                                        <input type="text" id="new_prov_cuit" class="form-control" placeholder="Solo números">
                                    </div>
                                    <div class="col-md-3">
                                        <button type="button" id="btnGuardarProv" class="btn btn-dark w-100 fw-bold">
                                            <i class="bi bi-save me-1"></i> Guardar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="ayuda-pane">
                <div class="row g-3">
                    <div class="col-md-6"><label class="form-label small fw-bold text-dark">PROGRAMA</label>{{ form.programa_ayuda }}</div>
                    <div class="col-md-6"><label class="form-label small fw-bold text-dark">MODALIDAD</label>{{ form.tipo_pago_persona }}</div>
                    <div class="col-12"><label class="form-label small fw-bold text-dark">DETALLE</label>{{ form.programa_ayuda_texto }}</div>
                </div>
            </div>

            <div class="tab-pane fade" id="vehiculo-pane">
                <div class="row g-3">
                    <div class="col-md-6"><label class="form-label small fw-bold text-dark">VEHÍCULO</label>{{ form.vehiculo }}</div>
                    <div class="col-md-3"><label class="form-label small fw-bold text-dark">LITROS</label>{{ form.litros }}</div>
                    <div class="col-md-3"><label class="form-label small fw-bold text-dark">TIPO</label>{{ form.tipo_combustible }}</div>
                    <div class="col-md-6"><label class="form-label small fw-bold text-dark">PRECIO UNIT.</label>{{ form.precio_unitario }}</div>
                    <div class="col-md-6"><label class="form-label small fw-bold text-muted">INFO</label>{{ form.vehiculo_texto }}</div>
                </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card border-0 shadow-sm rounded-4 mb-5">
        <div class="card-body p-4">
            <label class="form-label small fw-bold text-dark">NOTAS INTERNAS</label>
            {{ form.observaciones }}
        </div>
      </div>

      <div class="fixed-bottom bg-white border-top shadow-lg py-3" style="z-index: 1020;">
        <div class="container d-flex justify-content-end gap-2">
            <button type="submit" name="accion" value="borrador" class="btn btn-white border shadow-sm fw-bold text-secondary px-4">Borrador</button>
            <button type="submit" name="accion" value="aprobar" class="btn btn-success px-5 fw-bold shadow-sm">Aprobar Operación</button>
        </div>
      </div>

    </form>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<style>
    .text-indigo { color: #4f46e5 !important; }
    
    .form-control, .form-select { 
        border: 1px solid #cbd5e1; padding: 0.65rem 0.8rem; border-radius: 8px; 
    }
    .form-control:focus, .form-select:focus { 
        border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); 
    }
    
    /* Tabs */
    #assignTab .nav-link { 
        color: #000000 !important; font-weight: 800 !important; font-size: 1rem;
        letter-spacing: 0.5px; border: none; border-bottom: 4px solid transparent;
        transition: all 0.2s ease-in-out; opacity: 0.6;
    }
    #assignTab .nav-link:hover { background-color: #f8fafc; opacity: 1; }
    #assignTab .nav-link.active { 
        color: #000000 !important; opacity: 1; background: transparent; border-bottom-color: #0d6efd;
    }
    #assignTab #ayuda-tab.active { border-bottom-color: #dc3545; }
    #assignTab #vehiculo-tab.active { border-bottom-color: #0dcaf0; }
    
    input[readonly].bg-light { background-color: #e2e8f0 !important; color: #000 !important; font-weight: 600; border-color: #cbd5e1; }
</style>

<script>
    (function($) {
        "use strict";

        $(document).ready(function() {
            // VARIABLES
            const $tipo = $('#id_tipo');
            const $cat = $('#id_categoria');
            const urlApi = $('#movimientoForm').data('categorias-url');
            const $loading = $('#catLoading');
            const $badge = $('#catBadge');
            let currentAjaxRequest = null;

            // --- 1. PROVEEDOR EXPRESS ---
            $('#btnGuardarProv').click(function() {
                const nombre = $('#new_prov_nombre').val().trim();
                const cuit = $('#new_prov_cuit').val().trim();
                const btn = $(this);

                if (!nombre) {
                    Swal.fire("Falta nombre", "Debes ingresar la Razón Social", "warning");
                    return;
                }

                btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span>');

                $.ajax({
                    url: "{% url 'finanzas:proveedor_create_express' %}",
                    type: "POST",
                    data: {
                        'razon_social': nombre,
                        'cuit': cuit,
                        'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val()
                    },
                    success: function(response) {
                        var newOption = new Option(response.text, response.id, true, true);
                        $('#id_proveedor').append(newOption).trigger('change');
                        $('#id_proveedor_nombre').val(response.razon_social);
                        $('#id_proveedor_cuit').val(response.cuit);
                        $('#provNuevoBox').collapse('hide');
                        $('#new_prov_nombre').val('');
                        $('#new_prov_cuit').val('');
                        Swal.fire({
                            icon: 'success', title: '¡Creado!',
                            text: 'Proveedor agregado correctamente',
                            timer: 1500, showConfirmButton: false
                        });
                    },
                    error: function(xhr) {
                        let msg = "Error desconocido";
                        if (xhr.responseJSON && xhr.responseJSON.message) msg = xhr.responseJSON.message;
                        Swal.fire("Error", msg, "error");
                    },
                    complete: function() {
                        btn.prop('disabled', false).html('<i class="bi bi-save me-1"></i> Guardar');
                    }
                });
            });

            // --- 2. AUTOCOMPLETADOS ---
            
            // PERSONA
            $('#id_beneficiario').on('select2:select', function(e) {
                var data = e.params.data;
                var nombre = data.nombre && data.apellido ? data.apellido + ", " + data.nombre : data.text.split('(')[0].trim();
                var dni = data.dni || data.documento || (data.text.match(/\(([^)]+)\)/) || [])[1] || '';
                $('#id_beneficiario_nombre').val(nombre);
                $('#id_beneficiario_dni').val(dni);
            });
            $('#id_beneficiario').on('select2:clear', function() {
                $('#id_beneficiario_nombre').val(''); $('#id_beneficiario_dni').val('');
            });

            // PROVEEDOR
            $('#id_proveedor').on('select2:select', function(e) {
                var data = e.params.data;
                var nombre = data.text.split('(')[0].trim();
                var cuit = data.cuit || (data.text.match(/\(([^)]+)\)/) || [])[1] || '';
                $('#id_proveedor_nombre').val(nombre);
                $('#id_proveedor_cuit').val(cuit);
            });
            $('#id_proveedor').on('select2:clear', function() {
                $('#id_proveedor_nombre').val(''); $('#id_proveedor_cuit').val('');
            });

            // --- 3. LÓGICA CATEGORÍAS ---
            function cargarCategorias() {
                const tipoValor = $tipo.val();
                if (currentAjaxRequest) currentAjaxRequest.abort();

                if (!tipoValor) {
                    $cat.empty().append(new Option("---------", ""));
                    return;
                }

                $loading.removeClass('d-none');
                $cat.prop('disabled', true);

                currentAjaxRequest = $.ajax({
                    url: urlApi,
                    data: { 'tipo': tipoValor },
                    dataType: 'json',
                    success: function(data) {
                        $cat.empty().append(new Option("---------", ""));
                        data.results.forEach(function(item) {
                            const option = new Option(item.text, item.id, false, false);
                            $(option).data('ayuda', item.es_ayuda_social);
                            $(option).data('combustible', item.es_combustible);
                            $cat.append(option);
                        });

                        if ($cat.hasClass("select2-hidden-accessible")) $cat.select2('destroy');
                        
                        $cat.select2({
                            theme: 'bootstrap-5', width: '100%',
                            placeholder: 'Seleccione una categoría',
                            dropdownParent: $cat.parent()
                        });
                        actualizarInterfaz();
                    },
                    complete: function() {
                        $loading.addClass('d-none');
                        $cat.prop('disabled', false);
                        currentAjaxRequest = null;
                    }
                });
            }

            // === LÓGICA DE VISIBILIDAD (CORREGIDA) ===
            function actualizarInterfaz() {
                const tipoTexto = ($tipo.val() || "").toUpperCase();
                const esIngreso = tipoTexto.includes("INGRESO");
                const esTransferencia = tipoTexto.includes("TRANSFERENCIA");
                
                // GASTO se asume si no es ninguno de los otros dos y hay algo seleccionado
                const esGasto = (!esIngreso && !esTransferencia && tipoTexto !== "");

                // 1. PERSONA: Visible en INGRESO y GASTO. Oculta SOLO en TRANSFERENCIA.
                if (esTransferencia) {
                    $('#personaCard').addClass('d-none');
                } else {
                    $('#personaCard').removeClass('d-none');
                }
                
                // 2. PROVEEDOR / AYUDA / COMBUSTIBLE: Visible SOLO en GASTO.
                // (En ingresos, solo necesitamos la persona que paga, no proveedores)
                if (esGasto) {
                    $('#assignCard').removeClass('d-none');
                } else {
                    $('#assignCard').addClass('d-none');
                }

                // 3. CUENTAS
                // Origen: Oculto en INGRESO (la plata "aparece" en la cuenta destino)
                if (esIngreso) {
                    $('#cuentaOrigenWrap').addClass('d-none');
                } else {
                    $('#cuentaOrigenWrap').removeClass('d-none');
                }

                // Destino: Oculto en GASTO (la plata sale de la cuenta origen)
                if (esGasto) {
                    $('#cuentaDestinoWrap').addClass('d-none');
                } else {
                    $('#cuentaDestinoWrap').removeClass('d-none');
                }

                // 4. PESTAÑAS AUTOMÁTICAS (Solo para Gastos)
                if (esGasto) {
                    let esAyuda = false;
                    let esComb = false;
                    try {
                        const dataSelect2 = $cat.select2('data');
                        if (dataSelect2 && dataSelect2.length > 0) {
                            esAyuda = dataSelect2[0].es_ayuda_social === true;
                            esComb = dataSelect2[0].es_combustible === true;
                        }
                        if (!esAyuda && !esComb) {
                            const $opt = $cat.find(':selected');
                            esAyuda = $opt.data('ayuda') === true;
                            esComb = $opt.data('combustible') === true;
                        }
                    } catch(e) {}

                    if (esAyuda) {
                        $badge.removeClass('d-none bg-secondary bg-info').addClass('bg-danger').html('<i class="bi bi-heart"></i> Ayuda Social');
                        new bootstrap.Tab('#ayuda-tab').show();
                    } else if (esComb) {
                        $badge.removeClass('d-none bg-secondary bg-danger').addClass('bg-info text-dark').html('<i class="bi bi-fuel-pump"></i> Combustible');
                        new bootstrap.Tab('#vehiculo-tab').show();
                    } else {
                        $badge.addClass('d-none');
                        new bootstrap.Tab('#proveedor-tab').show();
                    }
                } else {
                    $badge.addClass('d-none');
                }
            }

            $tipo.on('change', function() { cargarCategorias(); });
            $cat.on('change', function() { actualizarInterfaz(); });

            $('#id_beneficiario, #id_proveedor, #id_vehiculo').select2({ theme: 'bootstrap-5', width: '100%' });

            const esEdicion = "{{ form.instance.pk|default:'' }}" !== "";
            if (!esEdicion && $tipo.val()) {
                cargarCategorias();
            } else {
                $cat.select2({ theme: 'bootstrap-5', width: '100%' });
            }
            actualizarInterfaz();
        });
    })(jQuery);
</script>
{% endblock %}