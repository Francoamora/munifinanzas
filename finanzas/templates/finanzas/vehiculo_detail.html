{% extends "finanzas/base.html" %}
{% load humanize %}
{% load static %}

{% block title %}Ficha: {{ vehiculo.patente }}{% endblock %}

{% block extra_css %}
<style>
    /* Estilo de Patente */
    .license-plate-lg {
        background: #1e293b;
        color: white;
        border: 3px solid #000;
        border-radius: 8px;
        padding: 8px 16px;
        font-family: 'Courier New', monospace;
        font-weight: 800;
        letter-spacing: 3px;
        text-transform: uppercase;
        font-size: 1.5rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        display: inline-block;
    }

    /* Tarjetas de Métricas */
    .stat-card {
        transition: transform 0.2s;
        border: 1px solid #f1f5f9;
    }
    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1) !important;
    }
    
    .timeline-icon {
        width: 32px; height: 32px;
        display: flex; align-items: center; justify-content: center;
        border-radius: 50%;
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}

<div class="d-flex flex-column flex-lg-row justify-content-between align-items-end mb-5 gap-4 animate-fade-in">
    <div class="d-flex align-items-center gap-4">
        <div class="bg-white p-3 rounded-4 shadow-sm border d-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
            {% if "CAMION" in vehiculo.descripcion|upper or "TRACTOR" in vehiculo.descripcion|upper %}
                <i class="bi bi-truck fs-1 text-secondary"></i>
            {% else %}
                <i class="bi bi-car-front-fill fs-1 text-secondary"></i>
            {% endif %}
        </div>
        
        <div>
            <div class="d-flex align-items-center gap-3 mb-2">
                <div class="license-plate-lg">{{ vehiculo.patente }}</div>
                {% if vehiculo.activo %}
                    <span class="badge bg-success-subtle text-success border border-success-subtle rounded-pill px-3 py-2">
                        <i class="bi bi-check-circle-fill me-1"></i>Operativo
                    </span>
                {% else %}
                    <span class="badge bg-danger-subtle text-danger border border-danger-subtle rounded-pill px-3 py-2">
                        <i class="bi bi-exclamation-triangle-fill me-1"></i>En Taller / Baja
                    </span>
                {% endif %}
            </div>
            <h1 class="h3 fw-bold text-dark mb-0">{{ vehiculo.descripcion }}</h1>
            <p class="text-secondary mb-0 small">{{ vehiculo.marca|default:"Marca no especificada" }} &bull; ID Sistema: #{{ vehiculo.id }}</p>
        </div>
    </div>

    <div class="d-flex gap-2">
        <a href="{% url 'finanzas:vehiculo_list' %}" class="btn btn-white border shadow-sm fw-medium">
            <i class="bi bi-arrow-left me-2"></i>Volver
        </a>
        
        {% if rol_staff_finanzas or rol_operador_finanzas %}
        <div class="dropdown">
            <button class="btn btn-primary shadow-sm fw-bold px-4 dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="bi bi-gear-fill me-2"></i>Gestionar
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0 rounded-3 p-2">
                <li><a class="dropdown-item rounded-2 mb-1" href="{% url 'finanzas:hoja_ruta_create' %}?vehiculo={{ vehiculo.pk }}"><i class="bi bi-play-circle me-2 text-success"></i>Iniciar Nuevo Viaje</a></li>
                <li><a class="dropdown-item rounded-2 mb-1" href="{% url 'finanzas:vehiculo_update' vehiculo.pk %}"><i class="bi bi-pencil me-2 text-primary"></i>Editar Datos</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item rounded-2 text-danger" href="#"><i class="bi bi-trash me-2"></i>Dar de Baja</a></li>
            </ul>
        </div>
        {% endif %}
    </div>
</div>

<div class="row g-4 mb-5">
    <div class="col-12 col-md-4">
        <div class="card border-0 shadow-sm h-100 stat-card rounded-4">
            <div class="card-body p-4">
                <div class="d-flex align-items-center gap-3 mb-3">
                    <div class="bg-primary bg-opacity-10 text-primary rounded-circle p-3">
                        <i class="bi bi-speedometer2 fs-4"></i>
                    </div>
                    <h6 class="text-uppercase text-muted fw-bold small ls-1 mb-0">Kilometraje Actual</h6>
                </div>
                <h2 class="fw-bold text-dark mb-1 font-monospace">{{ vehiculo.kilometraje_referencia|intcomma }} km</h2>
                <div class="small text-muted">Lectura de referencia</div>
            </div>
        </div>
    </div>

    <div class="col-12 col-md-4">
        <div class="card border-0 shadow-sm h-100 stat-card rounded-4">
            <div class="card-body p-4">
                <div class="d-flex align-items-center gap-3 mb-3">
                    <div class="bg-warning bg-opacity-10 text-warning rounded-circle p-3">
                        <i class="bi bi-fuel-pump fs-4"></i>
                    </div>
                    <h6 class="text-uppercase text-muted fw-bold small ls-1 mb-0">Consumo (6 Meses)</h6>
                </div>
                <h2 class="fw-bold text-dark mb-1">{{ total_litros_semestre|floatformat:1 }} L</h2>
                <div class="small text-muted">Total litros cargados</div>
            </div>
        </div>
    </div>

    <div class="col-12 col-md-4">
        <div class="card border-0 shadow-sm h-100 stat-card rounded-4">
            <div class="card-body p-4">
                <div class="d-flex align-items-center gap-3 mb-3">
                    <div class="bg-danger bg-opacity-10 text-danger rounded-circle p-3">
                        <i class="bi bi-cash-coin fs-4"></i>
                    </div>
                    <h6 class="text-uppercase text-muted fw-bold small ls-1 mb-0">Inversión (6 Meses)</h6>
                </div>
                <h2 class="fw-bold text-dark mb-1">${{ total_dinero_semestre|floatformat:0|intcomma }}</h2>
                <div class="small text-muted">Gasto en combustible</div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-header bg-white py-3 border-bottom">
                <h6 class="fw-bold text-dark mb-0"><i class="bi bi-card-list me-2"></i>Ficha Técnica</h6>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between py-3 border-light">
                        <span class="text-muted small text-uppercase fw-bold">Marca</span>
                        <span class="fw-medium text-dark">{{ vehiculo.marca|default:"-" }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between py-3 border-light">
                        <span class="text-muted small text-uppercase fw-bold">Modelo / Año</span>
                        <span class="fw-medium text-dark">{{ vehiculo.modelo|default:"-" }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between py-3 border-light">
                        <span class="text-muted small text-uppercase fw-bold">Tipo Combustible</span>
                        <span class="fw-medium text-dark">
                            {% if "NAFTA" in vehiculo.descripcion|upper %}Nafta{% elif "GASOIL" in vehiculo.descripcion|upper %}Diesel{% else %}No especificado{% endif %}
                        </span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between py-3 border-light">
                        <span class="text-muted small text-uppercase fw-bold">Chasis / VIN</span>
                        <span class="fw-medium text-dark font-monospace small">{{ vehiculo.chasis|default:"No registrado" }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between py-3 border-light">
                        <span class="text-muted small text-uppercase fw-bold">Motor</span>
                        <span class="fw-medium text-dark font-monospace small">{{ vehiculo.motor|default:"No registrado" }}</span>
                    </li>
                </ul>
                
                <div class="mt-4 p-3 bg-light rounded-3 border border-light">
                    <small class="d-block text-muted fw-bold mb-1">Notas / Observaciones</small>
                    <p class="small text-secondary mb-0 fst-italic">
                        {{ vehiculo.observaciones|default:"Sin observaciones adicionales." }}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-8">
        <div class="card border-0 shadow-sm rounded-4 h-100 overflow-hidden">
            <div class="card-header bg-white py-3 px-4 border-bottom d-flex justify-content-between align-items-center">
                <h6 class="fw-bold text-dark mb-0"><i class="bi bi-clock-history me-2"></i>Últimos Viajes (Hojas de Ruta)</h6>
                <a href="{% url 'finanzas:hoja_ruta_list' %}?q={{ vehiculo.patente }}" class="btn btn-link btn-sm text-decoration-none fw-bold small">Ver Todo</a>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light small text-uppercase text-secondary">
                        <tr>
                            <th class="ps-4 py-3">Fecha</th>
                            <th>Chofer</th>
                            <th>Destino / Detalle</th>
                            <th class="text-center">Km Rec.</th>
                            <th class="text-end pe-4">Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for hoja in hojas_ruta %}
                        <tr>
                            <td class="ps-4">
                                <div class="fw-bold text-dark">{{ hoja.fecha|date:"d/m/Y" }}</div>
                                <div class="small text-muted">#{{ hoja.id }}</div>
                            </td>
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    <div class="timeline-icon bg-light text-secondary border">
                                        <i class="bi bi-person"></i>
                                    </div>
                                    <span class="fw-medium">{{ hoja.chofer_nombre|default:hoja.chofer|default:"Sin Chofer" }}</span>
                                </div>
                            </td>
                            <td>
                                <div class="text-dark">{{ hoja.destino|default:"Recorrido Urbano"|truncatechars:30 }}</div>
                                {% if hoja.observaciones %}
                                    <div class="small text-muted fst-italic">{{ hoja.observaciones|truncatechars:40 }}</div>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if hoja.km_recorridos > 0 %}
                                    <span class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25 rounded-pill px-3">
                                        {{ hoja.km_recorridos|floatformat:0 }} km
                                    </span>
                                {% else %}
                                    <span class="text-muted small">-</span>
                                {% endif %}
                            </td>
                            <td class="text-end pe-4">
                                <a href="{% url 'finanzas:hoja_ruta_detail' hoja.pk %}" class="btn btn-sm btn-white border shadow-sm">
                                    <i class="bi bi-eye"></i>
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-5">
                                <i class="bi bi-cone-striped fs-1 text-muted opacity-25"></i>
                                <p class="text-muted mt-2 fw-medium">No hay viajes registrados recientemente.</p>
                                <a href="{% url 'finanzas:hoja_ruta_create' %}?vehiculo={{ vehiculo.pk }}" class="btn btn-sm btn-primary">Registrar Primer Viaje</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{% endblock %}