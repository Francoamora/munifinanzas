{% extends "finanzas/base.html" %}
{% load humanize %}

{% block title %}Ficha: {{ persona.apellido }}, {{ persona.nombre }}{% endblock %}

{% block extra_css %}
<style>
    /* =============================================
       SISTEMA DE COLORES (ALTO CONTRASTE)
    ============================================= */
    :root {
        --c-surface:    #ffffff;
        --c-canvas:     #f8fafc;
        --c-border:     #e2e8f0;
        
        --c-ink:        #0f172a; /* Texto principal súper oscuro */
        --c-ink-muted:  #475569; /* Texto secundario legible */
        
        --c-green:      #10b981;
        --c-blue:       #3b82f6;
        --c-purple:     #8b5cf6;
        --c-amber:      #f59e0b;
        --c-red:        #ef4444;
        --c-teal:       #0ea5e9;

        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 16px;

        --shadow-sm: 0 2px 4px rgba(0,0,0,0.04);
        --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.06);
    }

    .animate-in { animation: slideUpFade 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    .delay-1 { animation-delay: 0.1s; opacity: 0; }
    @keyframes slideUpFade {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .hover-lift { transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .hover-lift:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); z-index: 2; position: relative; }

    /* =============================================
       HERO HEADER & KPIs
    ============================================= */
    .profile-hero {
        background: var(--c-surface);
        border-radius: var(--radius-lg);
        border: 1px solid var(--c-border);
        box-shadow: var(--shadow-sm);
        margin-bottom: 2rem;
        overflow: hidden;
    }

    .profile-hero::before {
        content: ''; display: block; height: 5px; width: 100%;
        background: linear-gradient(90deg, var(--c-blue) 0%, var(--c-purple) 50%, var(--c-teal) 100%);
    }

    .avatar-pro {
        width: 100px; height: 100px; border-radius: 50%;
        background: linear-gradient(135deg, #0f172a 0%, #334155 100%); color: #fff;
        font-size: 2.5rem; font-weight: 800;
        display: flex; align-items: center; justify-content: center;
        border: 5px solid var(--c-surface); box-shadow: var(--shadow-sm);
    }
    
    .info-pill {
        display: inline-flex; align-items: center; gap: 0.5rem;
        background: var(--c-canvas); border: 1px solid var(--c-border);
        border-radius: 50px; padding: 0.4rem 1rem; font-size: 0.85rem; font-weight: 700;
        color: var(--c-ink);
    }

    .mini-status-box {
        background: var(--c-canvas); border: 1px solid var(--c-border);
        border-radius: var(--radius-md); padding: 1rem;
        display: flex; align-items: flex-start; gap: 1rem;
    }
    
    .kpi-strip {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        background: var(--c-canvas); border-top: 1px solid var(--c-border); gap: 1px;
    }
    .kpi-cell { background: var(--c-surface); padding: 1.25rem 1.5rem; }
    .kpi-label { font-size: 0.75rem; font-weight: 800; text-transform: uppercase; color: var(--c-ink-muted); margin-bottom: 0.25rem; }
    .kpi-value { font-size: 1.4rem; font-weight: 900; color: var(--c-ink); line-height: 1; }

    /* =============================================
       TABS Y CONTENIDO
    ============================================= */
    .tabs-card {
        background: var(--c-surface); border-radius: var(--radius-lg);
        border: 1px solid var(--c-border); box-shadow: var(--shadow-sm); overflow: hidden;
    }
    
    .tabs-header { background: var(--c-canvas); border-bottom: 1px solid var(--c-border); padding: 0.5rem 0.5rem 0; }
    .nav-tabs-pro { border: none; gap: 2px; flex-wrap: nowrap; overflow-x: auto; scrollbar-width: none; }
    .nav-tabs-pro::-webkit-scrollbar { display: none; }
    
    .nav-tabs-pro .nav-link {
        font-size: 0.85rem; font-weight: 700; color: var(--c-ink-muted);
        background: transparent; border: none; border-radius: 8px 8px 0 0;
        padding: 1rem 1.25rem; margin-bottom: -1px; transition: all 0.2s;
    }
    .nav-tabs-pro .nav-link:hover { color: var(--c-ink); background: rgba(0,0,0,0.03); }
    .nav-tabs-pro .nav-link.active {
        color: var(--c-ink) !important; background: var(--c-surface) !important;
        border: 1px solid var(--c-border); border-bottom-color: var(--c-surface);
    }
    
    /* Indicadores de color de pestaña activa */
    .nav-tabs-pro .nav-link.active::before { content: ''; position: absolute; top: -1px; left: -1px; right: -1px; height: 3px; border-radius: 3px 3px 0 0; }
    #ingresos-tab.active::before { background: var(--c-green); }
    #pagos-tab.active::before { background: var(--c-blue); }
    #ayudas-tab.active::before { background: var(--c-teal); }
    #viajes-tab.active::before { background: var(--c-purple); }
    #atenciones-tab.active::before { background: var(--c-amber); }
    #legajo-tab.active::before { background: var(--c-ink-muted); }
    
    #reservado-tab { color: var(--c-red) !important; opacity: 0.8; margin-left: auto; }
    #reservado-tab.active { opacity: 1; background: #fef2f2 !important; border-color: #fca5a5; border-bottom-color: var(--c-surface); }
    #reservado-tab.active::before { background: var(--c-red); }

    /* =============================================
       TABLAS Y LISTAS MODERNAS
    ============================================= */
    .table-modern { margin: 0; }
    .table-modern thead th {
        background: var(--c-canvas); font-size: 0.75rem; font-weight: 800;
        text-transform: uppercase; color: var(--c-ink-muted);
        padding: 1rem 1.5rem; border-bottom: 2px solid var(--c-border);
    }
    .table-modern tbody td { padding: 1.1rem 1.5rem; vertical-align: middle; border-bottom: 1px solid var(--c-border); color: var(--c-ink); }
    .table-modern tbody tr { transition: background 0.15s; }
    .table-modern tbody tr:hover { background: var(--c-canvas); }
    .table-modern tbody tr:last-child td { border-bottom: none; }

    /* Badges súper limpios */
    .badge-soft { padding: 0.4em 0.85em; font-weight: 700; border-radius: 6px; font-size: 0.75rem; letter-spacing: 0.3px; border: 1px solid transparent; }
    .bg-soft-green { background: #ecfdf5; color: #047857; border-color: #d1fae5; }
    .bg-soft-blue { background: #eff6ff; color: #1d4ed8; border-color: #dbeafe; }
    .bg-soft-teal { background: #f0fdfa; color: #0f766e; border-color: #ccfbf1; }
    .bg-soft-gray { background: var(--c-surface); color: var(--c-ink); border-color: var(--c-border); }

    .empty-state { padding: 4rem 2rem; text-align: center; color: var(--c-ink-muted); }
    .empty-icon { font-size: 2.5rem; opacity: 0.3; margin-bottom: 0.5rem; color: var(--c-ink); }
</style>
{% endblock %}

{% block content %}

<div class="profile-hero animate-in">
    <div class="p-4 p-lg-5 pb-lg-4">
        <div class="d-flex flex-column flex-lg-row gap-4 align-items-center align-items-lg-start">

            <div class="avatar-wrap">
                <div class="avatar-pro">
                    {{ persona.nombre|slice:":1" }}{{ persona.apellido|slice:":1" }}
                </div>
                <span class="position-absolute bottom-0 end-0 p-1 border border-3 border-white rounded-circle shadow-sm" 
                      style="background-color: {% if persona.activo %}var(--c-green){% else %}var(--c-red){% endif %}; width: 24px; height: 24px; right: 5px; bottom: 5px;" 
                      title="{% if persona.activo %}Activo en padrón{% else %}Inactivo{% endif %}" data-bs-toggle="tooltip">
                </span>
            </div>

            <div class="flex-grow-1 w-100 text-center text-lg-start">
                <div class="d-flex flex-column flex-lg-row justify-content-between align-items-center mb-3">
                    <h1 class="h2 fw-bolder text-dark mb-0" style="letter-spacing: -0.5px;">{{ persona.apellido }}, {{ persona.nombre }}</h1>
                    
                    <div class="d-flex gap-2 flex-shrink-0 mt-3 mt-lg-0">
                        {% if persona.telefono %}
                        <a href="https://wa.me/549{{ persona.telefono|cut:' '|cut:'-' }}" target="_blank" class="btn btn-success btn-sm fw-bold rounded-pill px-4 shadow-sm hover-lift">
                            <i class="bi bi-whatsapp me-1"></i> WhatsApp
                        </a>
                        {% endif %}
                        <a href="{% url 'finanzas:persona_update' persona.pk %}" class="btn btn-dark btn-sm fw-bold rounded-pill px-4 shadow-sm hover-lift">
                            <i class="bi bi-pencil-square me-1"></i> Editar Ficha
                        </a>
                    </div>
                </div>

                <div class="d-flex flex-wrap justify-content-center justify-content-lg-start gap-2 mb-4">
                    <span class="info-pill"><i class="bi bi-person-vcard text-secondary fs-6"></i> {{ persona.dni|default:"S/D" }}</span>
                    <span class="info-pill"><i class="bi bi-geo-alt-fill text-danger fs-6"></i> {{ persona.direccion }}</span>
                    {% if persona.fecha_nacimiento %}
                    <span class="info-pill"><i class="bi bi-cake2-fill text-warning fs-6"></i> {{ persona.fecha_nacimiento|date:"d/m/Y" }}</span>
                    {% endif %}
                </div>

                <div class="row g-3">
                    <div class="col-12 col-xl-6">
                        <div class="mini-status-box hover-lift">
                            <div class="bg-primary bg-opacity-10 text-primary rounded-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; flex-shrink: 0;">
                                <i class="bi bi-briefcase-fill fs-5"></i>
                            </div>
                            <div>
                                <div class="small text-uppercase fw-bolder text-muted mb-1" style="font-size: 0.7rem;">Relación Laboral</div>
                                {% if persona.tipo_vinculo != "NINGUNO" %}
                                    <div class="fw-bolder text-dark fs-6 lh-1">{{ persona.get_tipo_vinculo_display }}</div>
                                    <div class="small fw-bold text-secondary mt-1">{{ persona.sector_laboral|default:"Sector no definido" }}</div>
                                {% else %}
                                    <div class="text-dark fw-bold small mt-1">Sin vínculo activo.</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="col-12 col-xl-6">
                        <div class="mini-status-box hover-lift">
                            <div class="bg-info bg-opacity-10 text-info rounded-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; flex-shrink: 0;">
                                <i class="bi bi-bank2 fs-5"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <div class="small text-uppercase fw-bolder text-muted" style="font-size: 0.7rem;">ANSES / Nacionales</div>
                                    {% if persona.percibe_beneficio %}<span class="badge bg-success rounded-pill">ACTIVO</span>{% endif %}
                                </div>
                                {% if persona.percibe_beneficio %}
                                    <div class="fw-bolder text-dark lh-1 mb-1">{{ persona.beneficio_organismo }}</div>
                                    {% if perms_ver_dinero_global or perms_ver_dinero %}
                                        <div class="small text-dark fw-bold mt-1">Monto Aprox: ${{ persona.beneficio_monto_aprox|default:"0"|intcomma }}</div>
                                    {% endif %}
                                {% else %}
                                    <div class="text-dark fw-bold small mt-1">No registra beneficios.</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                {% if persona.notas %}
                <div class="mt-3 p-3 bg-warning bg-opacity-10 border border-warning border-opacity-25 rounded-3">
                    <strong class="text-warning text-uppercase d-block mb-1" style="font-size: 0.75rem;"><i class="bi bi-sticky-fill me-1"></i>Notas internas</strong>
                    <span class="small text-dark fw-bold">{{ persona.notas }}</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="kpi-strip">
        {% if perms_ver_dinero_global or perms_ver_dinero %}
            <div class="kpi-cell border-end">
                <div class="kpi-label"><i class="bi bi-box-arrow-in-right me-1 text-success"></i> Ingresos (Tesorería)</div>
                <div class="kpi-value">${{ total_pagado_historico|default:"0"|intcomma }}</div>
            </div>
            <div class="kpi-cell border-end">
                <div class="kpi-label"><i class="bi bi-cash-stack me-1 text-blue"></i> Sueldos / Servicios</div>
                <div class="kpi-value">${{ total_jornales|default:"0"|intcomma }}</div>
            </div>
            <div class="kpi-cell border-end">
                <div class="kpi-label"><i class="bi bi-heart-pulse-fill me-1 text-teal"></i> Ayuda Social Total</div>
                <div class="kpi-value">${{ total_ayuda_historica|default:"0"|intcomma }}</div>
            </div>
        {% else %}
            <div class="kpi-cell border-end">
                <div class="kpi-label"><i class="bi bi-journal-text me-1 text-warning"></i> Casos M. Entrada</div>
                <div class="kpi-value">{{ persona.atenciones.count }}</div>
            </div>
        {% endif %}
        <div class="kpi-cell">
            <div class="kpi-label"><i class="bi bi-bus-front-fill me-1" style="color: var(--c-purple);"></i> Viajes Realizados</div>
            <div class="kpi-value">{{ persona.get_cantidad_viajes }}</div>
        </div>
    </div>
</div>

<div class="tabs-card animate-in delay-1">
    
    <div class="tabs-header">
        <ul class="nav nav-tabs-pro" id="historialTabs" role="tablist">
            
            {% if perms_ver_dinero_global or perms_ver_dinero %}
            <li class="nav-item" role="presentation">
                <button class="nav-link active position-relative" id="ingresos-tab" data-bs-toggle="tab" data-bs-target="#ingresos" type="button">
                    <i class="bi bi-receipt me-1 fs-6"></i> <span class="d-none d-md-inline">Tributos / Ingresos</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link position-relative" id="pagos-tab" data-bs-toggle="tab" data-bs-target="#pagos" type="button">
                    <i class="bi bi-cash-stack me-1 fs-6"></i> <span class="d-none d-md-inline">Sueldos / Jornales</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link position-relative" id="ayudas-tab" data-bs-toggle="tab" data-bs-target="#ayudas" type="button">
                    <i class="bi bi-heart-pulse-fill me-1 fs-6"></i> <span class="d-none d-md-inline">Asistencia Social</span>
                </button>
            </li>
            {% endif %}

            <li class="nav-item" role="presentation">
                <button class="nav-link position-relative {% if not perms_ver_dinero_global and not perms_ver_dinero %}active{% endif %}" id="viajes-tab" data-bs-toggle="tab" data-bs-target="#viajes" type="button">
                    <i class="bi bi-bus-front-fill me-1 fs-6"></i> <span class="d-none d-md-inline">Traslados</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link position-relative" id="atenciones-tab" data-bs-toggle="tab" data-bs-target="#atenciones" type="button">
                    <i class="bi bi-journal-text me-1 fs-6"></i> <span class="d-none d-md-inline">Mesa Entrada</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link position-relative" id="legajo-tab" data-bs-toggle="tab" data-bs-target="#legajo" type="button">
                    <i class="bi bi-folder2-open me-1 fs-6"></i> <span class="d-none d-md-inline">Legajo</span>
                </button>
            </li>
            
            {% if es_equipo_genero %}
            <li class="nav-item ms-auto" role="presentation">
                <button class="nav-link position-relative" id="reservado-tab" data-bs-toggle="tab" data-bs-target="#reservado" type="button">
                    <i class="bi bi-shield-lock-fill me-1 fs-6"></i> <span class="d-none d-md-inline">Reservado</span>
                </button>
            </li>
            {% endif %}
        </ul>
    </div>

    <div class="tab-content bg-white" id="historialTabsContent">

        {% if perms_ver_dinero_global or perms_ver_dinero %}
        
        <div class="tab-pane fade show active" id="ingresos" role="tabpanel">
            <div class="table-responsive">
                <table class="table table-modern align-middle">
                    <thead>
                        <tr>
                            <th class="ps-4">Fecha</th>
                            <th>Imputación Contable</th>
                            <th>Descripción Pública</th>
                            <th class="text-end pe-4">Importe Abonado</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for mov in pagos_servicios %}
                        <tr onclick="window.location.href='{% url 'finanzas:movimiento_detail' mov.pk %}'" style="cursor: pointer;">
                            <td class="ps-4 fw-bolder text-dark">{{ mov.fecha_operacion|date:"d/m/Y" }}</td>
                            <td><span class="badge-soft bg-soft-green">{{ mov.categoria.nombre }}</span></td>
                            <td><div class="text-dark fw-bold small text-truncate" style="max-width: 250px;">{{ mov.descripcion }}</div></td>
                            <td class="text-end pe-4">
                                <span class="fw-bolder text-success fs-5">+${{ mov.monto|intcomma }}</span>
                                <a href="{% url 'finanzas:recibo_print' mov.pk %}" target="_blank" class="btn btn-sm btn-light border ms-3 shadow-sm hover-lift" title="Imprimir Recibo" onclick="event.stopPropagation();">
                                    <i class="bi bi-printer-fill text-dark"></i>
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="4">
                            <div class="empty-state">
                                <div class="empty-icon"><i class="bi bi-receipt"></i></div>
                                <p class="fw-bolder text-dark mb-0 fs-5">Sin pagos registrados</p>
                                <span class="text-muted small fw-bold">El vecino no registra tributos o ingresos en caja.</span>
                            </div>
                        </td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="pagos" role="tabpanel">
            <div class="table-responsive">
                <table class="table table-modern align-middle">
                    <thead>
                        <tr>
                            <th class="ps-4">Fecha</th>
                            <th>Categoría</th>
                            <th>Detalle del Servicio</th>
                            <th class="text-end pe-4">Importe Pagado</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in historial_laboral %}
                        <tr onclick="window.location.href='{% url 'finanzas:movimiento_detail' item.pk %}'">
                            <td class="ps-4 fw-bolder text-dark">{{ item.fecha_operacion|date:"d/m/Y" }}</td>
                            <td><span class="badge-soft bg-soft-blue">{{ item.categoria.nombre }}</span></td>
                            <td class="text-dark fw-bold small">{{ item.descripcion|truncatechars:80 }}</td>
                            <td class="text-end pe-4 fw-bolder text-dark fs-5">${{ item.monto|intcomma }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="4">
                            <div class="empty-state">
                                <div class="empty-icon"><i class="bi bi-briefcase"></i></div>
                                <p class="fw-bolder text-dark mb-0 fs-5">Sin pagos laborales</p>
                                <span class="text-muted small fw-bold">No se registran pagos por jornales o servicios prestados.</span>
                            </div>
                        </td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="ayudas" role="tabpanel">
            <div class="px-4 py-3 bg-light border-bottom d-flex flex-wrap gap-4 align-items-center">
                <div>
                    <span class="text-muted small fw-bolder text-uppercase d-block mb-1">Subsidios Efectivo</span>
                    <span class="fs-4 fw-black text-dark">${{ total_caja|default:"0"|intcomma }}</span>
                </div>
                <div class="vr bg-secondary opacity-25 d-none d-sm-block"></div>
                <div>
                    <span class="text-muted small fw-bolder text-uppercase d-block mb-1">Vales / Materiales</span>
                    <span class="fs-4 fw-black text-dark">${{ total_especies|default:"0"|intcomma }}</span>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-modern align-middle">
                    <thead>
                        <tr>
                            <th class="ps-4">Fecha</th>
                            <th>Modalidad</th>
                            <th>Concepto / Bienes Entregados</th>
                            <th class="text-end pe-4">Inversión Social</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in historial_unificado %}
                        {% if item.tipo_registro == 'CAJA_AYUDA' %}
                        <tr onclick="window.location.href='{% url 'finanzas:movimiento_detail' item.pk %}'">
                            <td class="ps-4 fw-bolder text-dark">{{ item.fecha_operacion|date:"d/m/Y" }}</td>
                            <td><span class="badge-soft bg-soft-green"><i class="bi bi-cash me-1"></i>Efectivo</span></td>
                            <td>
                                <div class="fw-bolder text-dark mb-1">{{ item.descripcion }}</div>
                                <span class="badge-soft bg-soft-gray border-0 py-1" style="font-size: 0.65rem;">{{ item.categoria.nombre }}</span>
                            </td>
                            <td class="text-end pe-4 fw-bolder text-dark fs-5">${{ item.monto|intcomma }}</td>
                        </tr>
                        {% else %}
                        <tr onclick="window.location.href='{% url 'finanzas:oc_detail' item.pk %}'">
                            <td class="ps-4">
                                <div class="fw-bolder text-dark">{{ item.fecha_oc|date:"d/m/Y" }}</div>
                                <div class="text-muted small fw-bold">#{{ item.numero }}</div>
                            </td>
                            <td><span class="badge-soft bg-soft-teal"><i class="bi bi-basket2 me-1"></i>Vale Insumos</span></td>
                            <td>
                                <div class="fw-bolder text-dark mb-1"><i class="bi bi-box-seam me-1 text-teal"></i>{{ item.lineas.first.descripcion|default:"Insumos varios" }}</div>
                                <div class="small fw-bold text-muted"><i class="bi bi-shop me-1"></i>{{ item.proveedor_nombre|truncatechars:35 }}</div>
                            </td>
                            <td class="text-end pe-4">
                                <div class="fw-bolder text-dark fs-5">${{ item.total_monto|intcomma }}</div>
                                {% if item.estado == 'BORRADOR' %}
                                <div class="small text-warning fw-bolder mt-1"><i class="bi bi-hourglass-split me-1"></i>Pendiente</div>
                                {% else %}
                                <div class="small text-success fw-bolder mt-1"><i class="bi bi-check-circle-fill me-1"></i>Autorizado</div>
                                {% endif %}
                            </td>
                        </tr>
                        {% endif %}
                        {% empty %}
                        <tr><td colspan="4">
                            <div class="empty-state">
                                <div class="empty-icon"><i class="bi bi-heart-pulse"></i></div>
                                <p class="fw-bolder text-dark mb-0 fs-5">Sin historial social</p>
                                <span class="text-muted small fw-bold">No se registran ayudas o subsidios entregados.</span>
                            </div>
                        </td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <div class="tab-pane fade {% if not perms_ver_dinero_global and not perms_ver_dinero %}show active{% endif %} p-4 bg-light" id="viajes" role="tabpanel">
            <div class="row g-3">
                {% for viaje in persona.get_historial_viajes %}
                <div class="col-12 col-xl-6">
                    <div class="bg-white rounded-4 p-3 shadow-sm border d-flex align-items-center hover-lift h-100">
                        <div class="bg-light border rounded-3 text-center p-2 me-3" style="min-width: 65px;">
                            <div class="fs-4 fw-black text-dark lh-1">{{ viaje.hoja_ruta.fecha|date:"d" }}</div>
                            <div class="text-muted small fw-bolder text-uppercase mt-1" style="font-size: 0.65rem;">{{ viaje.hoja_ruta.fecha|date:"M" }}</div>
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start mb-1">
                                <h6 class="mb-0 fw-bolder text-dark">{{ viaje.destino }}</h6>
                                <span class="badge rounded-pill fw-bold" style="background: #f3e8ff; color: #7e22ce;">TRASLADO</span>
                            </div>
                            <div class="text-dark small fw-bold mt-2">
                                <i class="bi bi-truck me-1 text-muted"></i>{{ viaje.hoja_ruta.vehiculo.patente }}
                                <span class="mx-2 text-muted">|</span>
                                <i class="bi bi-info-circle me-1 text-muted"></i>{{ viaje.motivo|default:"Atención Médica" }}
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12">
                    <div class="empty-state bg-white border rounded-4">
                        <div class="empty-icon"><i class="bi bi-bus-front"></i></div>
                        <p class="fw-bolder text-dark mb-0 fs-5">Sin viajes asignados</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="tab-pane fade" id="atenciones" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center p-4 border-bottom bg-light">
                <span class="text-dark small fw-bolder text-uppercase">Casos Registrados</span>
                <a href="{% url 'finanzas:atencion_create' %}?persona={{ persona.pk }}" class="btn btn-dark btn-sm rounded-pill px-4 fw-bold shadow-sm hover-lift">
                    <i class="bi bi-plus-lg me-1"></i> Nuevo caso
                </a>
            </div>
            <div>
                {% for atencion in persona.atenciones.all %}
                <div class="p-4 border-bottom bg-white hover-lift">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="fw-bolder text-dark mb-0 fs-5">{{ atencion.get_motivo_principal_display }}</h5>
                        <span class="badge-soft border shadow-sm {% if atencion.estado == 'ABIERTA' %}bg-warning text-dark{% elif atencion.estado == 'EN_SEGUIMIENTO' %}bg-info text-dark{% else %}bg-success text-white{% endif %}">
                            {{ atencion.estado }}
                        </span>
                    </div>
                    <p class="text-dark fw-bold small mb-3" style="max-width: 800px;">{{ atencion.descripcion }}</p>
                    <div class="text-muted fw-bolder small"><i class="bi bi-calendar3 me-1"></i>{{ atencion.fecha_atencion|date:"d/m/Y" }}</div>
                </div>
                {% empty %}
                <div class="empty-state">
                    <div class="empty-icon"><i class="bi bi-journal-text"></i></div>
                    <p class="fw-bolder text-dark mb-0 fs-5">Mesa de Entrada vacía</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="tab-pane fade" id="legajo" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center p-4 border-bottom bg-light">
                <span class="text-dark small fw-bolder text-uppercase">Documentación</span>
                <button type="button" class="btn btn-dark btn-sm rounded-pill px-4 fw-bold shadow-sm hover-lift" data-bs-toggle="modal" data-bs-target="#uploadModal">
                    <i class="bi bi-cloud-upload me-1"></i> Subir Archivo
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-modern align-middle">
                    <tbody>
                        {% for doc in persona.documentos.all %}
                        <tr>
                            <td class="ps-4" style="width: 5%;">
                                <div class="bg-light text-secondary border rounded-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;"><i class="bi bi-file-earmark-text-fill fs-5"></i></div>
                            </td>
                            <td style="width: 20%;"><span class="badge-soft bg-soft-gray fw-bolder">{{ doc.get_tipo_display }}</span></td>
                            <td>
                                <div class="fw-bolder text-dark mb-1">{{ doc.descripcion|default:"Documento general" }}</div>
                                <div class="small fw-bold text-muted">{{ doc.archivo.name|truncatechars:40 }}</div>
                            </td>
                            <td class="small fw-bolder text-dark">{{ doc.fecha_subida|date:"d/m/Y" }}</td>
                            <td class="text-end pe-4">
                                <a href="{{ doc.archivo.url }}" target="_blank" class="btn btn-light btn-sm rounded-pill border shadow-sm fw-bold px-4 hover-lift">
                                    <i class="bi bi-eye-fill text-dark me-1"></i> Ver
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="5">
                            <div class="empty-state">
                                <div class="empty-icon"><i class="bi bi-folder2-open"></i></div>
                                <p class="fw-bolder text-dark mb-0 fs-5">Legajo digital vacío</p>
                            </div>
                        </td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        {% if es_equipo_genero %}
        <div class="tab-pane fade" id="reservado" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center p-4 bg-danger bg-opacity-10 border-bottom border-danger border-opacity-25">
                <span class="text-danger small fw-bolder text-uppercase">
                    <i class="bi bi-shield-lock-fill me-1"></i> Bóveda Protegida
                </span>
                <button type="button" class="btn btn-danger btn-sm rounded-pill px-4 fw-bold shadow-sm hover-lift" data-bs-toggle="modal" data-bs-target="#uploadSensibleModal">
                    <i class="bi bi-lock-fill me-1"></i> Archivar Confidencial
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-modern align-middle">
                    <tbody>
                        {% for doc in persona.documentos_sensibles.all %}
                        <tr class="bg-danger bg-opacity-10">
                            <td class="ps-4" style="width: 5%;">
                                <div class="bg-danger text-white rounded-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;"><i class="bi bi-file-earmark-lock2-fill fs-5"></i></div>
                            </td>
                            <td style="width: 20%;"><span class="badge bg-danger rounded-pill fw-bold px-3 py-2 shadow-sm">{{ doc.get_tipo_display }}</span></td>
                            <td>
                                <div class="fw-bolder text-dark mb-1 fs-6">{{ doc.descripcion|default:"Archivo clasificado" }}</div>
                                <div class="small fw-bold text-dark">
                                    <i class="bi bi-person-fill me-1 text-danger"></i>{{ doc.subido_por.username }}
                                    <span class="mx-2 text-muted">|</span>{{ doc.fecha_subida|date:"d/m/Y H:i" }}
                                </div>
                            </td>
                            <td class="text-end pe-4">
                                <a href="{{ doc.archivo.url }}" target="_blank" class="btn btn-outline-danger btn-sm rounded-pill shadow-sm px-4 fw-bold bg-white hover-lift">
                                    <i class="bi bi-key-fill me-1"></i> Abrir
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="4">
                            <div class="empty-state">
                                <div class="empty-icon text-danger opacity-50"><i class="bi bi-shield-check"></i></div>
                                <p class="fw-bolder text-danger mb-0 fs-5">Sin documentos restringidos</p>
                            </div>
                        </td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

    </div>
</div>

<div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-bottom-0 pb-0 pt-4 px-4">
                <h5 class="fw-bolder text-dark">Adjuntar al Legajo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form action="{% url 'finanzas:persona_documento_create' persona.pk %}" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-dark text-uppercase">Clasificación</label>
                        <select name="tipo" class="form-select bg-light border-0 shadow-none fw-bold text-dark">
                            <option value="DNI">DNI / Identificación</option>
                            <option value="CUD">Certificado Discapacidad</option>
                            <option value="INFORME">Informe Social</option>
                            <option value="NOTA">Nota / Solicitud</option>
                            <option value="RECIBO">Recibo Firmado</option>
                            <option value="OTRO" selected>Otro Documento</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-dark text-uppercase">Archivo</label>
                        <input type="file" name="archivo" class="form-control bg-light border-0 shadow-none text-dark fw-bold" required>
                    </div>
                    <div class="mb-4">
                        <label class="form-label small fw-bold text-dark text-uppercase">Breve Descripción</label>
                        <input type="text" name="descripcion" class="form-control bg-light border-0 shadow-none text-dark fw-bold" placeholder="Ej: Copia DNI actualizado">
                    </div>
                    <button type="submit" class="btn btn-dark w-100 rounded-pill py-2 fw-bolder shadow-sm">Guardar en legajo</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% if es_equipo_genero %}
<div class="modal fade" id="uploadSensibleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4" style="border-top: 5px solid var(--c-red) !important;">
            <div class="modal-header border-bottom-0 pb-0 pt-4 px-4">
                <h5 class="fw-bolder text-danger">
                    <i class="bi bi-shield-lock me-1"></i> Bóveda Reservada
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="alert alert-danger bg-opacity-10 border-0 small fw-bolder text-danger d-flex gap-2 mb-4">
                    <i class="bi bi-exclamation-triangle-fill fs-5"></i>
                    <span>Este documento quedará encriptado y será invisible para usuarios no autorizados.</span>
                </div>
                <form action="{% url 'finanzas:persona_doc_sensible_create' persona.pk %}" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-dark text-uppercase">Naturaleza del Documento</label>
                        <select name="tipo" class="form-select bg-light border-danger border-opacity-25 shadow-none fw-bold text-dark">
                            <option value="INFORME_PSI">Informe Psicológico</option>
                            <option value="DENUNCIA">Denuncia / Judicial</option>
                            <option value="MEDIDA">Medida de Protección</option>
                            <option value="SEGUIMIENTO">Ficha de Seguimiento</option>
                            <option value="OTRO">Otro Reservado</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-dark text-uppercase">Cargar Archivo</label>
                        <input type="file" name="archivo" class="form-control bg-light border-danger border-opacity-25 shadow-none fw-bold text-dark" required>
                    </div>
                    <div class="mb-4">
                        <label class="form-label small fw-bold text-dark text-uppercase">Referencia</label>
                        <input type="text" name="descripcion" class="form-control bg-light border-danger border-opacity-25 shadow-none fw-bold text-dark" placeholder="Ej: Exp. Judicial N° 445/26">
                    </div>
                    <button type="submit" class="btn btn-danger w-100 rounded-pill py-2 fw-bolder shadow-sm">
                        <i class="bi bi-lock-fill me-1"></i> Sellar y Guardar
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
    document.addEventListener("DOMContentLoaded", function () {
        [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            .forEach(el => new bootstrap.Tooltip(el));
    });
</script>

{% endblock %}