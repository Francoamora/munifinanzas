{% extends "finanzas/base.html" %}
{% load humanize %}
{% load finanzas_extras %}

{% block title %}Movimiento #{{ movimiento.id }}{% endblock %}

{% block content %}

{% with rol_staff_finanzas|default:request.user.is_staff as is_staff_fin %}
<div class="row justify-content-center">
  <div class="col-12 col-lg-9 col-xl-8">

    <div class="d-flex justify-content-between align-items-center mb-4 print-hide">
      <a href="{% url 'finanzas:movimiento_list' %}" class="btn btn-light border btn-sm shadow-sm hover-lift">
        <i class="bi bi-arrow-left me-1"></i> Volver
      </a>

      <div class="d-flex gap-2 align-items-center">

        {% if is_staff_fin %}
          
          {% if movimiento.esta_borrador %}
            <form method="post" action="{% url 'finanzas:movimiento_cambiar_estado' movimiento.pk 'aprobar' %}" class="d-inline">
              {% csrf_token %}
              <button type="submit" class="btn btn-success btn-sm fw-bold shadow-sm"
                      onclick="return confirm('¿Confirmás APROBAR? Se impactará en caja.');">
                <i class="bi bi-check-lg me-1"></i> Aprobar
              </button>
            </form>

            <form method="post" action="{% url 'finanzas:movimiento_cambiar_estado' movimiento.pk 'rechazar' %}" class="d-inline">
              {% csrf_token %}
              <button type="submit" class="btn btn-outline-danger btn-sm fw-bold shadow-sm"
                      onclick="return confirm('¿Confirmás RECHAZAR este movimiento?');">
                <i class="bi bi-x-circle me-1"></i> Rechazar
              </button>
            </form>
          {% endif %}

          <a href="{% url 'finanzas:movimiento_update' movimiento.pk %}" class="btn btn-primary btn-sm shadow-sm">
            <i class="bi bi-pencil-square me-1"></i> Editar
          </a>

        {% endif %}

        {% if movimiento.tipo == 'INGRESO' and movimiento.estado == 'APROBADO' %}
            <a href="{% url 'finanzas:movimiento_recibo_print' movimiento.pk %}" target="_blank" class="btn btn-dark btn-sm fw-bold shadow-sm hover-lift">
                <i class="bi bi-printer-fill me-1"></i> Recibo
            </a>
        {% else %}
            <button onclick="window.print()" class="btn btn-secondary btn-sm shadow-sm">
                <i class="bi bi-printer me-1"></i> Imprimir Ficha
            </button>
        {% endif %}

      </div>
    </div>

    <div class="card border-0 shadow-lg rounded-4 overflow-hidden mb-5" id="printableArea">

      <div class="card-header border-0 py-3 text-center
        {% if movimiento.esta_borrador %}bg-warning text-dark
        {% elif movimiento.esta_rechazado %}bg-danger text-white
        {% else %}bg-success text-white{% endif %}">
        <span class="fw-bold text-uppercase small ls-1">{{ movimiento.get_estado_display }}</span>
      </div>

      <div class="card-body p-4 p-md-5">

        <div class="text-center mb-4">
          <div class="text-muted text-uppercase small fw-bold mb-1">
            {% if movimiento.tipo == "TRANSFERENCIA" %}
              Transferencia Interna
            {% elif movimiento.tipo == "INGRESO" %}
              Ingreso
            {% else %}
              Gasto / Egreso
            {% endif %}
          </div>

          <div class="display-5 fw-bold mb-2
            {% if movimiento.tipo == "INGRESO" %}text-success
            {% elif movimiento.tipo == "TRANSFERENCIA" %}text-primary
            {% else %}text-danger{% endif %}">
            ${{ movimiento.monto|formato_pesos }}
          </div>

          <div class="text-muted small">
            <i class="bi bi-calendar-event me-1"></i> {{ movimiento.fecha_operacion|date:"d/m/Y" }}
            <span class="mx-2">•</span>
            <i class="bi bi-hash me-1"></i> ID <strong>#{{ movimiento.id }}</strong>
          </div>

          {% if movimiento.tipo == "TRANSFERENCIA" %}
            <div class="mt-3 d-flex flex-column flex-md-row justify-content-center gap-2">
              {% if movimiento.cuenta_origen_texto %}
                <span class="badge bg-light text-dark border">
                  <i class="bi bi-box-arrow-up-right text-danger me-1"></i> Origen: {{ movimiento.cuenta_origen_texto }}
                </span>
              {% endif %}
              {% if movimiento.cuenta_destino_texto %}
                <span class="badge bg-light text-dark border">
                  <i class="bi bi-box-arrow-in-down-left text-success me-1"></i> Destino: {{ movimiento.cuenta_destino_texto }}
                </span>
              {% endif %}
            </div>
          {% endif %}
        </div>

        <hr class="border-light my-4">

        <div class="row g-4 mb-4">
          <div class="col-md-7">
            <small class="text-uppercase text-muted fw-bold d-block mb-1">Descripción</small>
            <div class="fs-5 fw-semibold text-dark">{{ movimiento.descripcion }}</div>
          </div>
          <div class="col-md-5">
            <small class="text-uppercase text-muted fw-bold d-block mb-1">Imputación</small>
            <span class="badge bg-light text-dark border fs-6 fw-normal">
              {{ movimiento.categoria|default:"Sin categoría" }}
            </span>
            {% if movimiento.area %}
            <div class="small text-muted mt-1">
              <i class="bi bi-diagram-3 me-1"></i>{{ movimiento.area }}
            </div>
            {% endif %}
          </div>
        </div>

        {% if movimiento.proveedor or movimiento.proveedor_nombre %}
          <div class="bg-light p-3 rounded-3 border mb-3">
            <div class="d-flex align-items-center mb-2">
              <i class="bi bi-shop fs-5 text-muted me-2"></i>
              <span class="fw-bold text-dark">Proveedor</span>
            </div>
            <div class="ms-4">
              <div class="fw-bold text-dark">
                {% if movimiento.proveedor %}
                  {{ movimiento.proveedor.nombre }}
                {% else %}
                  {{ movimiento.proveedor_nombre }}
                {% endif %}
              </div>
              {% if movimiento.proveedor_cuit or movimiento.proveedor.cuit %}
                <small class="text-muted font-monospace">
                  CUIT: {% firstof movimiento.proveedor.cuit movimiento.proveedor_cuit %}
                </small>
              {% endif %}
            </div>
          </div>
        {% endif %}

        {% if movimiento.beneficiario or movimiento.beneficiario_nombre %}
          <div class="bg-light p-3 rounded-3 border mb-3">
            <div class="d-flex align-items-center mb-2">
              <i class="bi bi-person-heart fs-5 text-muted me-2"></i>
              <span class="fw-bold text-dark">Persona / Beneficiario</span>
            </div>
            <div class="ms-4">
              <div class="fw-bold text-dark">
                {% if movimiento.beneficiario %}
                  {{ movimiento.beneficiario }}
                {% else %}
                  {{ movimiento.beneficiario_nombre }}
                {% endif %}
              </div>

              {% if movimiento.beneficiario_dni %}
                <small class="text-muted font-monospace">DNI: {{ movimiento.beneficiario_dni }}</small>
              {% endif %}

              <div class="mt-1 small text-muted">
                {% if movimiento.tipo_pago_persona and movimiento.tipo_pago_persona != "NINGUNO" %}
                    Modalidad: {{ movimiento.tipo_pago_persona }}
                {% endif %}
              </div>

              {% if movimiento.programa_ayuda %}
                <div class="mt-2 badge bg-danger-subtle text-danger border border-danger-subtle">
                  {{ movimiento.programa_ayuda }}
                </div>
              {% endif %}

              {% if movimiento.programa_ayuda_texto %}
                <div class="mt-2 small text-muted">{{ movimiento.programa_ayuda_texto }}</div>
              {% endif %}
            </div>
          </div>
        {% endif %}

        {% if movimiento.vehiculo or movimiento.vehiculo_texto %}
          <div class="bg-light p-3 rounded-3 border mb-3">
            <div class="d-flex align-items-center mb-2">
              <i class="bi bi-fuel-pump fs-5 text-muted me-2"></i>
              <span class="fw-bold text-dark">Carga de Combustible</span>
            </div>
            <div class="ms-4">
              <div class="fw-bold text-dark">{% firstof movimiento.vehiculo movimiento.vehiculo_texto %}</div>
              <small class="text-muted">
                {% if movimiento.litros %}
                    <strong>{{ movimiento.litros }} Litros</strong>
                {% endif %}
                {% if movimiento.tipo_combustible %} 
                    • {{ movimiento.tipo_combustible }}
                {% endif %}
                {% if movimiento.precio_unitario %} 
                    • ${{ movimiento.precio_unitario|formato_pesos }}/L
                {% endif %}
              </small>
            </div>
          </div>
        {% endif %}

        {% if is_staff_fin and movimiento.observaciones %}
          <div class="alert alert-secondary border-0 shadow-sm mt-4 print-hide">
            <div class="d-flex gap-2 align-items-start">
              <i class="bi bi-shield-lock-fill fs-5 mt-1"></i>
              <div>
                <div class="fw-bold mb-1">Notas internas (Privado)</div>
                <div class="small text-dark opacity-75">{{ movimiento.observaciones|linebreaksbr }}</div>
              </div>
            </div>
          </div>
        {% endif %}

        <div class="mt-5 pt-4 border-top">
          <div class="row small text-muted">
            <div class="col-6">
              Cargado por:
              <strong>{{ movimiento.creado_por.get_full_name|default:movimiento.creado_por }}</strong>
              <br>
              Fecha: <strong>{{ movimiento.fecha_carga|date:"d/m/Y H:i" }}</strong>
            </div>
            <div class="col-6 text-end">
              Comuna de Tacuarendí<br>
              Sistema de Gestión Integral
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>
</div>

<style>
  .ls-1 { letter-spacing: .06em; }

  @media print {
    body * { visibility: hidden; }
    #printableArea, #printableArea * { visibility: visible; }
    #printableArea {
      position: absolute; left: 0; top: 0; width: 100%;
      margin: 0; border: none !important; box-shadow: none !important;
    }
    .print-hide { display: none !important; }
    .card-header { color: black !important; background: #eee !important; -webkit-print-color-adjust: exact; }
  }
</style>
{% endwith %}

{% endblock %}