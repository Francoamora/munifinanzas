{% extends "finanzas/base.html" %}
{% load humanize %}

{% block title %}Atenciones de {{ beneficiario }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4">
  <div>
    <h1 class="h3 fw-bold text-dark mb-1">Atenciones</h1>
    <div class="text-muted small">
      Historial de <strong>{{ beneficiario.apellido }}, {{ beneficiario.nombre }}</strong>
      {% if beneficiario.dni %}— DNI {{ beneficiario.dni }}{% endif %}
    </div>
  </div>
  <div class="d-flex gap-2">
    <a href="{% url 'finanzas:persona_detail' beneficiario.pk %}" class="btn btn-outline-secondary">Volver a Persona</a>
    <a href="{% url 'finanzas:atencion_create' %}?persona={{ beneficiario.pk }}&next={{ request.path|urlencode }}"
       class="btn btn-primary shadow-sm">
      <i class="bi bi-plus-lg me-1"></i> Nueva Atención
    </a>
  </div>
</div>

<div class="card border-0 shadow-sm rounded-4 overflow-hidden">
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="bg-light small text-uppercase text-muted">
        <tr>
          <th class="ps-4">Fecha</th>
          <th>Motivo</th>
          <th>Estado</th>
          <th>Área</th>
          <th class="text-end pe-4">Acción</th>
        </tr>
      </thead>
      <tbody>
        {% for a in atenciones %}
        <tr>
          <td class="ps-4">
            <div class="fw-bold text-dark">{{ a.fecha_atencion|date:"d/m/Y" }}</div>
            <div class="small text-muted">#{{ a.id }}</div>
          </td>
          <td>
            <span class="badge bg-primary-subtle text-primary border border-primary-subtle">
              {{ a.get_motivo_principal_display }}
            </span>
            {% if a.descripcion %}
              <div class="small text-muted mt-1">{{ a.descripcion|truncatechars:80 }}</div>
            {% endif %}
          </td>
          <td>
            {% if a.estado == "ABIERTA" %}
              <span class="badge bg-success-subtle text-success border border-success-subtle">ABIERTA</span>
            {% elif a.estado == "EN_SEGUIMIENTO" %}
              <span class="badge bg-warning-subtle text-warning border border-warning-subtle">SEGUIMIENTO</span>
            {% else %}
              <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle">CERRADA</span>
            {% endif %}
          </td>
          <td>{{ a.area|default:"-" }}</td>
          <td class="text-end pe-4">
            <a href="{% url 'finanzas:atencion_update' a.pk %}?next={{ request.path|urlencode }}"
               class="btn btn-sm btn-outline-secondary">
              Editar <i class="bi bi-chevron-right ms-1"></i>
            </a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5" class="text-center py-5">
            <div class="text-muted opacity-50 mb-3"><i class="bi bi-journal-x fs-1"></i></div>
            <p class="mb-0 text-muted">Todavía no hay atenciones para esta persona.</p>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="card-footer bg-white border-top-0 py-3">
    {% include "finanzas/components/pagination.html" %}
  </div>
</div>
{% endblock %}
