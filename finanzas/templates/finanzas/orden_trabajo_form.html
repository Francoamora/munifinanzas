{% extends "finanzas/base.html" %}
{% load humanize static %}

{#
  FORMULARIO DE ORDEN DE TRABAJO
  Contexto:
    - form: OrdenTrabajoForm
    - orden: instancia o None
    - hoy: date (opcional)
#}

{% block title %}
  {% if orden %}
    Editar orden de trabajo #{{ orden.numero|default:orden.id }} – Comuna de Tacuarendí
  {% else %}
    Nueva orden de trabajo – Comuna de Tacuarendí
  {% endif %}
{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-start mb-3 flex-wrap gap-2">
  <div>
    <p class="text-muted small mb-1 d-flex flex-wrap align-items-center gap-2">
      <span>Órdenes de trabajo</span>
      <span>·</span>
      {% if orden %}
        <span>Edición de OT #{{ orden.numero|default:orden.id }}</span>
      {% else %}
        <span>Nueva orden</span>
      {% endif %}
    </p>
    <h1 class="h4 mb-1">
      {% if orden %}
        Editar orden de trabajo #{{ orden.numero|default:orden.id }}
      {% else %}
        Nueva orden de trabajo
      {% endif %}
    </h1>
    <div class="small text-muted">
      Definí el trabajo, asigná área / responsable y, si corresponde, vinculalo a un vehículo o equipo.
    </div>
  </div>

  <div class="d-flex flex-column align-items-end gap-2">
    <a href="{% url 'finanzas:orden_trabajo_list' %}" class="btn btn-outline-secondary btn-sm">
      Volver al listado
    </a>
    <span class="badge bg-light text-muted border small d-none d-md-inline-block">
      {% if hoy %}
        Fecha de hoy: {{ hoy|date:"d/m/Y" }}
      {% else %}
        Fecha de hoy: {% now "d/m/Y" %}
      {% endif %}
    </span>
  </div>
</div>

<form method="post" novalidate class="card shadow-sm" autocomplete="off" role="form" aria-label="Formulario de orden de trabajo">
  {% csrf_token %}
  <div class="card-body">
    {% if form.non_field_errors %}
      <div class="alert alert-danger py-2 small">
        {{ form.non_field_errors }}
      </div>
    {% endif %}

    {# Ocultamos campos técnicos (si existen) #}
    {% for hidden in form.hidden_fields %}
      {{ hidden }}
    {% endfor %}

    {# ========== BLOQUE 1: DATOS GENERALES ========== #}
    <h2 class="h6 text-uppercase text-muted mb-2">Datos generales</h2>
    <div class="row g-3 mb-3">
      <div class="col-12 col-md-6">
        <label class="form-label mb-1" for="{{ form.descripcion.id_for_label }}">
          Descripción / resumen del trabajo
        </label>
        {{ form.descripcion }}
        <div class="form-text small">
          Contá brevemente qué trabajo se va a realizar.
        </div>
        {% for error in form.descripcion.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>

      <div class="col-6 col-md-3">
        <label class="form-label mb-1" for="{{ form.estado.id_for_label }}">Estado</label>
        {{ form.estado }}
        {% for error in form.estado.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>

      <div class="col-6 col-md-3">
        <label class="form-label mb-1" for="{{ form.prioridad.id_for_label }}">Prioridad</label>
        {{ form.prioridad }}
        {% for error in form.prioridad.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>

      <div class="col-12 col-md-4">
        <label class="form-label mb-1" for="{{ form.fecha_ot.id_for_label }}">Fecha de la orden</label>
        {{ form.fecha_ot }}
        {% for error in form.fecha_ot.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>

      <div class="col-12 col-md-4">
        <label class="form-label mb-1" for="{{ form.tipo_trabajo.id_for_label }}">Tipo de trabajo</label>
        {{ form.tipo_trabajo }}
        <div class="form-text small">
          Ej.: mecánica, eléctrica, obra, servicio a vecino, etc.
        </div>
        {% for error in form.tipo_trabajo.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>

      <div class="col-12 col-md-4">
        <label class="form-label mb-1" for="{{ form.numero.id_for_label }}">Número interno (opcional)</label>
        {{ form.numero }}
        <div class="form-text small">
          Podés usar un código como “OT-0001/2025”. Si lo dejás vacío, se puede completar más adelante.
        </div>
        {% for error in form.numero.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>
    </div>

    {# ========== BLOQUE 2: SOLICITANTE Y RESPONSABLE ========== #}
    <h2 class="h6 text-uppercase text-muted mb-2">Solicitante y responsable</h2>
    <div class="row g-3 mb-3">

      {# --- Buscador avanzado de solicitante (censo) + texto libre --- #}
      <div class="col-12">
        <div id="solicitante-wrapper"
             class="mb-2"
             data-persona-suggest-url="{% url 'finanzas:persona_suggest' %}">
          <label class="form-label mb-1">Solicitante</label>

          <div class="row g-2 align-items-start">
            <div class="col-12 col-md-6">
              <div class="small text-muted mb-1">
                Buscá por <strong>apellido, nombre o DNI</strong>.  
                Al seleccionar, se completa el solicitante del censo.
              </div>

              <input
                type="text"
                id="solicitante-query"
                class="form-control form-control-sm"
                placeholder="Ej: Pérez Juan, 30123456"
                autocomplete="off"
              >

              <div id="solicitante-results"
                   class="list-group list-group-flush small mt-1"
                   style="max-height: 220px; overflow-y: auto;">
              </div>

              {% if form.solicitante_texto %}
                <div class="mt-3">
                  <label class="form-label mb-1" for="{{ form.solicitante_texto.id_for_label }}">
                    Solicitante (texto libre, si no está en censo)
                  </label>
                  {{ form.solicitante_texto }}
                  <div class="form-text small">
                    Para instituciones o casos donde no tengas la persona en el censo.
                  </div>
                  {% for error in form.solicitante_texto.errors %}
                    <div class="text-danger small">{{ error }}</div>
                  {% endfor %}
                </div>
              {% endif %}
            </div>

            <div class="col-12 col-md-6">
              <div class="small text-muted mb-1">
                Seleccionado
              </div>
              <div id="solicitante-preview"
                   class="border rounded-1 p-2 small bg-light">
                <span class="text-muted">Ninguna persona seleccionada todavía.</span>
              </div>
            </div>
          </div>

          {# Select original, escondido pero funcional (fallback sin JS) #}
          <div class="d-none">
            {{ form.solicitante }}
            {% for error in form.solicitante.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="col-12 col-md-6">
        <label class="form-label mb-1" for="{{ form.area.id_for_label }}">Área responsable</label>
        {{ form.area }}
        {% for error in form.area.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>

      <div class="col-12 col-md-6">
        <label class="form-label mb-1" for="{{ form.responsable_texto.id_for_label }}">
          Responsable / encargado del trabajo
        </label>
        {{ form.responsable_texto }}
        <div class="form-text small">
          Escribí el nombre de quien se hace cargo por la comuna.  
          Ej: <em>Juan Pérez – Capataz</em>, <em>Equipo de mantenimiento</em>, etc.
        </div>
        {% if form.responsable_texto.errors %}
          <div class="text-danger small mt-1">
            {{ form.responsable_texto.errors|join:", " }}
          </div>
        {% endif %}
      </div>
    </div>

    {# ========== BLOQUE 3: VEHÍCULO / EQUIPO ========== #}
    <div class="d-flex align-items-center justify-content-between mb-1">
      <h2 class="h6 text-uppercase text-muted mb-0">Vehículo / equipo</h2>
      <span class="badge bg-light text-muted border small">
        Opcional · Solo si corresponde
      </span>
    </div>
    <p class="text-muted small mb-2">
      Completá este dato cuando el trabajo esté asociado a un vehículo municipal, maquinaria o equipo específico.
    </p>

    <div class="row g-3 mb-3">
      <div class="col-12 col-md-6">
        <label class="form-label mb-1" for="{{ form.vehiculo.id_for_label }}">Vehículo (catálogo)</label>
        {{ form.vehiculo }}
        <div class="form-text small">
          Si ya tenés cargado el vehículo en el módulo de vehículos, seleccionalo acá.
        </div>
        {% for error in form.vehiculo.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>
    </div>

    {# ========== BLOQUE 4: DETALLE DEL TRABAJO ========== #}
    <h2 class="h6 text-uppercase text-muted mb-2">Detalle del trabajo</h2>
    <div class="row g-3 mb-3">
      <div class="col-12 col-md-7">
        <label class="form-label mb-1" for="{{ form.trabajos_realizados.id_for_label }}">Trabajos realizados</label>
        {{ form.trabajos_realizados }}
        <div class="form-text small">
          Usalo para registrar qué se hizo efectivamente (se puede completar al cerrar la OT).
        </div>
        {% for error in form.trabajos_realizados.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>
      <div class="col-12 col-md-5">
        <label class="form-label mb-1" for="{{ form.observaciones.id_for_label }}">Notas internas / observaciones</label>
        {{ form.observaciones }}
        <div class="form-text small">
          Comentarios internos del taller, aclaraciones o seguimiento (no se imprimen).
        </div>
        {% for error in form.observaciones.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>
    </div>

    {# ========== BLOQUE 5: MONTOS / COBRO ========== #}
    <h2 class="h6 text-uppercase text-muted mb-2">Montos / cobro (opcional)</h2>
    <div class="row g-3">
      <div class="col-12 col-md-4">
        <label class="form-label mb-1" for="{{ form.importe_estimado.id_for_label }}">Importe estimado</label>
        {{ form.importe_estimado }}
        {% for error in form.importe_estimado.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>
      <div class="col-12 col-md-4">
        <label class="form-label mb-1" for="{{ form.importe_final.id_for_label }}">Importe final</label>
        {{ form.importe_final }}
        {% for error in form.importe_final.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>
      <div class="col-12 col-md-4">
        <label class="form-label mb-1" for="{{ form.categoria_ingreso.id_for_label }}">Categoría contable (ingreso)</label>
        {{ form.categoria_ingreso }}
        {% for error in form.categoria_ingreso.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>
    </div>

  </div>

  <div class="card-footer d-flex justify-content-between align-items-center flex-wrap gap-2">
    <div class="small text-muted">
      Revisá el estado y la prioridad antes de guardar. Siempre vas a poder editar la OT más adelante.
    </div>
    <div class="d-flex flex-wrap gap-2">
      <a href="{% url 'finanzas:orden_trabajo_list' %}" class="btn btn-outline-secondary btn-sm">
        Cancelar
      </a>
      <button type="submit" class="btn btn-primary btn-sm">
        Guardar orden de trabajo
      </button>
    </div>
  </div>
</form>

{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script>
    window.PERSONA_SUGGEST_URL = "{% url 'finanzas:persona_suggest' %}";
  </script>
  <script src="{% static 'finanzas/js/orden_trabajo_form.js' %}"></script>
{% endblock %}
