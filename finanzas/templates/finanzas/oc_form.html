{% extends "finanzas/base.html" %}
{% load static %}
{% load humanize %}

{% block title %}
    {% if orden.pk %}Editar OC #{{ orden.numero }}{% else %}Nueva Orden de Compra{% endif %}
{% endblock %}

{% block extra_css %}
<style>
    /* 1. Estética: Más espacio en la tabla */
    .table-relaxed td, .table-relaxed th {
        padding-top: 0.8rem !important;
        padding-bottom: 0.8rem !important;
        vertical-align: middle;
    }
    
    /* 2. Limpieza: Eliminar flechas de los inputs numéricos */
    .no-arrow::-webkit-outer-spin-button,
    .no-arrow::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    .no-arrow {
        -moz-appearance: textfield;
    }

    /* 3. Inputs modernos */
    .form-control, .form-select { border-color: #cbd5e1; }
    .form-control:focus, .form-select:focus { border-color: #0d6efd; box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.15); }
    
    /* 4. Switch Manual/Auto */
    .btn-check:checked + .btn-outline-primary {
        background-color: #0d6efd;
        color: white;
        border-color: #0d6efd;
    }
</style>
{% endblock %}

{% block content %}

<div class="row justify-content-center animate-fade-in" style="padding-bottom: 120px;">
    
    <div class="col-12 col-xl-10">

        <form method="post" novalidate id="ocForm" data-url-proveedores="{% url 'finanzas:oc_proveedores_suggest' %}">
            {% csrf_token %}
            
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4 gap-3">
                <div>
                    <h1 class="h3 fw-bold text-dark mb-1">
                        {% if orden.pk %}
                            <i class="bi bi-pencil-square me-2 text-primary"></i>Editar OC <span class="text-muted">#{{ orden.numero }}</span>
                        {% else %}
                            <i class="bi bi-cart-plus-fill me-2 text-primary"></i>Nueva Orden de Compra
                        {% endif %}
                    </h1>
                    <p class="text-secondary mb-0 small fw-medium">Gestión de aprovisionamiento.</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{% url 'finanzas:oc_list' %}" class="btn btn-white border shadow-sm px-3 fw-bold text-secondary">
                        Cancelar
                    </a>
                    {% if not orden or orden.estado == 'BORRADOR' %}
                    <button type="submit" class="btn btn-primary shadow-sm fw-bold px-4 hover-lift">
                        <i class="bi bi-save2 me-2"></i>Guardar OC
                    </button>
                    {% endif %}
                </div>
            </div>

            {% if form.errors %}
            <div class="alert alert-danger shadow-sm border-0 mb-4 rounded-3">
                <div class="d-flex align-items-center gap-3">
                    <i class="bi bi-exclamation-triangle-fill fs-4"></i>
                    <div>
                        <strong>Hay errores en el formulario:</strong>
                        <ul class="mb-0 ps-3 small">
                            {% for field in form %}
                                {% for error in field.errors %}<li>{{ field.label }}: {{ error }}</li>{% endfor %}
                            {% endfor %}
                            {% if form.non_field_errors %}<li>{{ form.non_field_errors }}</li>{% endif %}
                        </ul>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden">
                <div class="card-header bg-white py-3 px-4 border-bottom d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold text-dark text-uppercase small ls-1">
                        <i class="bi bi-sliders me-2 text-primary"></i>Configuración de la Orden
                    </h6>
                </div>
                <div class="card-body p-4 bg-light bg-opacity-25">
                    <div class="row g-4">
                        <div class="col-md-4">
                            <label class="form-label small fw-bold text-dark mb-2">MODO DE NUMERACIÓN</label>
                            <div class="d-flex gap-2">
                                {% for radio in form.tipo_numeracion %}
                                    {{ radio.tag }}
                                    <label class="btn btn-outline-primary btn-sm fw-bold rounded-pill px-3" for="{{ radio.id_for_label }}">
                                        {% if radio.data.value == 'AUTO' %}<i class="bi bi-magic me-1"></i>{% else %}<i class="bi bi-pen me-1"></i>{% endif %}
                                        {{ radio.choice_label }}
                                    </label>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label small fw-bold text-dark">N° COMPROBANTE</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0 text-muted"><i class="bi bi-hash"></i></span>
                                {{ form.numero }}
                            </div>
                            <div id="numHelp" class="form-text small mt-1 text-primary fw-bold"></div>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label small fw-bold text-dark">FECHA EMISIÓN</label>
                            {{ form.fecha_oc }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm rounded-4 mb-4">
                <div class="card-body p-4">
                    <div class="row g-4">
                        <div class="col-12 col-lg-6">
                            <label class="form-label small fw-bold text-dark">BUSCAR PROVEEDOR *</label>
                            <select name="{{ form.proveedor.name }}" id="id_proveedor" class="form-select" required>
                                {% if form.instance.proveedor %}
                                    <option value="{{ form.instance.proveedor.id }}" selected>
                                        {{ form.instance.proveedor.nombre }} ({{ form.instance.proveedor.cuit }})
                                    </option>
                                {% endif %}
                            </select>
                            
                            <div class="d-none">
                                {{ form.proveedor_nombre }}
                                {{ form.proveedor_cuit }}
                            </div>
                        </div>

                        <div class="col-md-6 col-lg-3">
                            <label class="form-label small fw-bold text-dark">RUBRO PRINCIPAL</label>
                            {{ form.rubro_principal }}
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <label class="form-label small fw-bold text-dark">ÁREA SOLICITANTE</label>
                            {{ form.area }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden">
                <div class="card-header bg-dark text-white py-3 px-4 d-flex justify-content-between align-items-center">
                    <span class="fw-bold text-uppercase small ls-1"><i class="bi bi-list-check me-2"></i>Detalle de Items</span>
                    <div class="bg-white text-dark rounded-pill px-4 py-1 fw-bold shadow-sm d-flex align-items-center gap-2">
                        <span class="small text-secondary text-uppercase">Total:</span>
                        <span id="totalDisplay" class="font-monospace fs-5">$ 0,00</span>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle table-relaxed" id="tablaItems">
                        <thead class="bg-light text-secondary small text-uppercase fw-bold">
                            <tr>
                                <th class="ps-4" style="width: 25%;">Categoría</th>
                                <th style="width: 15%;">Área Item</th>
                                <th style="width: 35%;">Descripción</th>
                                <th class="text-end pe-4" style="width: 20%;">Monto ($)</th>
                                <th class="text-center" style="width: 5%;"></th>
                            </tr>
                        </thead>
                        <tbody id="lineas-container">
                            {{ lineas.management_form }}
                            
                            {% for form in lineas %}
                                <tr class="linea-row bg-white">
                                    {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
                                    <td class="ps-4">{{ form.categoria }}</td>
                                    <td>{{ form.area }}</td>
                                    <td>{{ form.descripcion }}</td>
                                    <td class="pe-4">
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text bg-light border-end-0 text-muted">$</span>
                                            {{ form.monto }}
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        {% if lineas.can_delete %}
                                            <div class="d-none">{{ form.DELETE }}</div> 
                                            <button type="button" class="btn btn-sm btn-outline-danger border-0 btn-delete-row shadow-none">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="p-3 bg-light border-top text-center">
                    <button type="button" id="add-row" class="btn btn-outline-primary btn-sm fw-bold border-2 rounded-pill px-4 hover-lift">
                        <i class="bi bi-plus-lg me-1"></i> AGREGAR ÍTEM
                    </button>
                </div>
            </div>

            <div class="card border-0 shadow-sm rounded-4 mb-5">
                <div class="card-body p-4">
                    <label class="form-label small fw-bold text-dark text-uppercase">Notas Adicionales</label>
                    {{ form.observaciones }}
                </div>
            </div>

        </form>
    </div>
</div>

<script type="text/template" id="empty-row-template">
    <tr class="linea-row bg-white animate-fade-in">
        {% with lineas.empty_form as form %}
            {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
            <td class="ps-4">{{ form.categoria }}</td>
            <td>{{ form.area }}</td>
            <td>{{ form.descripcion }}</td>
            <td class="pe-4">
                <div class="input-group input-group-sm">
                    <span class="input-group-text bg-light border-end-0 text-muted">$</span>
                    {{ form.monto }}
                </div>
            </td>
            <td class="text-center">
                <div class="d-none">{{ form.DELETE }}</div>
                <button type="button" class="btn btn-sm btn-outline-danger border-0 btn-delete-row shadow-none">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        {% endwith %}
    </tr>
</script>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    
    // 1. SWITCH AUTO/MANUAL
    const radios = document.querySelectorAll('input[name="tipo_numeracion"]');
    const inputNumero = document.getElementById('id_numero');
    const helpText = document.getElementById('numHelp');

    function updateNumeracionState() {
        let checkedRadio = document.querySelector('input[name="tipo_numeracion"]:checked');
        let selected = checkedRadio ? checkedRadio.value : 'AUTO'; // Default a AUTO si no hay nada
        
        if (selected === 'AUTO') {
            inputNumero.setAttribute('readonly', true);
            inputNumero.classList.add('bg-light');
            inputNumero.value = ''; 
            inputNumero.placeholder = "Se generará automáticamente";
            helpText.innerText = "El sistema asignará el siguiente número disponible.";
        } else {
            inputNumero.removeAttribute('readonly');
            inputNumero.classList.remove('bg-light');
            inputNumero.placeholder = "Ej: 000504";
            if(document.activeElement !== inputNumero) inputNumero.focus();
            helpText.innerText = "Ingrese el número del talonario físico.";
        }
    }
    // Event Listeners
    radios.forEach(radio => radio.addEventListener('change', updateNumeracionState));
    // Init
    if(radios.length > 0) updateNumeracionState();


    // 2. PROVEEDOR SELECT2
    const $proveedor = $('#id_proveedor');
    const urlProveedores = $('#ocForm').data('url-proveedores');
    const $totalDisplay = $('#totalDisplay');
    
    $proveedor.select2({
        theme: 'bootstrap-5',
        width: '100%',
        placeholder: 'Buscar por nombre o CUIT...',
        allowClear: true,
        ajax: {
            url: urlProveedores,
            dataType: 'json',
            delay: 250,
            data: params => ({ q: params.term, page: params.page }),
            processResults: data => ({ results: data.results }),
            cache: true
        },
        minimumInputLength: 1
    });

    $proveedor.on('select2:select', function (e) {
        var data = e.params.data;
        var nombre = data.text.split('(')[0].trim();
        var cuit = "";
        
        if(data.cuit) cuit = data.cuit;
        else {
            var match = data.text.match(/\(([^)]+)\)/);
            if(match) cuit = match[1];
        }
        $('#id_proveedor_nombre').val(nombre);
        $('#id_proveedor_cuit').val(cuit);
    });

    $proveedor.on('select2:clear', function() {
        $('#id_proveedor_nombre').val('');
        $('#id_proveedor_cuit').val('');
    });


    // 3. FORMSET DINÁMICO (Con corrección de Template)
    const $container = $('#lineas-container');
    const $totalForms = $('#id_lineas-TOTAL_FORMS');

    $('#add-row').click(function() {
        var formIdx = parseInt($totalForms.val());
        
        // CORRECCIÓN: Leemos el HTML virgen desde el <script>, no del DOM renderizado
        var templateSource = document.getElementById('empty-row-template').innerHTML;
        var newRowHtml = templateSource.replace(/__prefix__/g, formIdx);
        var $newRow = $(newRowHtml);
        
        // Agregamos la fila limpia
        $container.append($newRow);
        
        // Inicializamos Select2 SOLO en los nuevos selects
        $newRow.find('select').select2({ theme: 'bootstrap-5', width: '100%' });
        
        $totalForms.val(formIdx + 1);
        bindEvents();
    });

    $container.on('click', '.btn-delete-row', function() {
        var $row = $(this).closest('tr');
        $row.find('input[type="checkbox"]').prop('checked', true);
        $row.hide();
        calcularTotal();
    });


    // 4. CÁLCULOS
    function calcularTotal() {
        let total = 0;
        $('input[name$="-monto"]').each(function() {
            var $row = $(this).closest('tr');
            if ($row.is(':hidden')) return;
            
            let val = parseFloat($(this).val().replace(',', '.'));
            if (!isNaN(val)) total += val;
        });
        
        const formatter = new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 2 });
        $totalDisplay.text(formatter.format(total));
    }

    function bindEvents() {
        $('input[name$="-monto"]').off('input').on('input', calcularTotal);
    }

    // INIT
    bindEvents();
    calcularTotal();
    // Inicializar select2 en las filas ya existentes (si es edición)
    $('#lineas-container select').select2({ theme: 'bootstrap-5', width: '100%' });
});
</script>
{% endblock %}