{% extends "finanzas/base.html" %}
{% load static %}
{% load humanize %}
{% load widget_tweaks %}

{% block title %}
    {% if form.instance.pk %}Editar OC #{{ form.instance.numero }}{% else %}Nueva Orden de Compra{% endif %}
{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

<style>
    /* 1. Estética: Más espacio en la tabla */
    .table-relaxed td, .table-relaxed th {
        padding-top: 0.8rem !important;
        padding-bottom: 0.8rem !important;
        vertical-align: middle;
    }
    
    /* 2. Limpieza: Eliminar flechas de los inputs numéricos */
    .no-arrow::-webkit-outer-spin-button,
    .no-arrow::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    .no-arrow {
        -moz-appearance: textfield;
    }

    /* 3. Inputs modernos */
    .form-control, .form-select { border-color: #cbd5e1; }
    .form-control:focus, .form-select:focus { border-color: #0d6efd; box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.15); }
    
    /* 4. Switch Manual/Auto */
    .btn-check:checked + .btn-outline-primary {
        background-color: #0d6efd;
        color: white;
        border-color: #0d6efd;
    }
    
    /* 5. Ajustes Select2 */
    .select2-container--bootstrap-5 .select2-selection {
        border-color: #cbd5e1;
    }
</style>
{% endblock %}

{% block content %}

<div class="row justify-content-center animate-fade-in" style="padding-bottom: 120px;">
    
    <div class="col-12 col-xl-10">

        <form method="post" novalidate id="ocForm">
            {% csrf_token %}
            
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4 gap-3">
                <div>
                    <h1 class="h3 fw-bold text-dark mb-1">
                        {% if form.instance.pk %}
                            <i class="bi bi-pencil-square me-2 text-primary"></i>Editar OC <span class="text-muted">#{{ form.instance.numero }}</span>
                        {% else %}
                            <i class="bi bi-cart-plus-fill me-2 text-primary"></i>Nueva Orden de Compra
                        {% endif %}
                    </h1>
                    <p class="text-secondary mb-0 small fw-medium">Gestión de aprovisionamiento.</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{% url 'finanzas:oc_list' %}" class="btn btn-white border shadow-sm px-3 fw-bold text-secondary hover-lift">
                        Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary shadow-sm fw-bold px-4 hover-lift">
                        <i class="bi bi-save2 me-2"></i>Guardar OC
                    </button>
                </div>
            </div>

            {% if form.errors %}
            <div class="alert alert-danger shadow-sm border-0 mb-4 rounded-3 animate-fade-in">
                <div class="d-flex align-items-center gap-3">
                    <i class="bi bi-exclamation-triangle-fill fs-4"></i>
                    <div>
                        <strong>Hay errores en el formulario:</strong>
                        <ul class="mb-0 ps-3 small">
                            {% for field in form %}
                                {% for error in field.errors %}<li>{{ field.label }}: {{ error }}</li>{% endfor %}
                            {% endfor %}
                            {% if form.non_field_errors %}<li>{{ form.non_field_errors }}</li>{% endif %}
                        </ul>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden">
                <div class="card-header bg-white py-3 px-4 border-bottom d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold text-dark text-uppercase small ls-1">
                        <i class="bi bi-sliders me-2 text-primary"></i>Configuración
                    </h6>
                </div>
                <div class="card-body p-4 bg-light bg-opacity-25">
                    <div class="row g-4">
                        <div class="col-md-4">
                            <label class="form-label small fw-bold text-dark mb-2">MODO DE NUMERACIÓN</label>
                            <div class="d-flex gap-2">
                                {% for radio in form.tipo_numeracion %}
                                    <div class="flex-fill">
                                        {{ radio.tag }}
                                        <label class="btn btn-outline-primary btn-sm fw-bold rounded-pill w-100" for="{{ radio.id_for_label }}">
                                            {% if radio.data.value == 'AUTO' %}<i class="bi bi-magic me-1"></i>{% else %}<i class="bi bi-pen me-1"></i>{% endif %}
                                            {{ radio.choice_label }}
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label small fw-bold text-dark">N° COMPROBANTE</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0 text-muted"><i class="bi bi-hash"></i></span>
                                {{ form.numero }}
                            </div>
                            <div id="numHelp" class="form-text small mt-1 text-primary fw-bold"></div>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label small fw-bold text-dark">FECHA EMISIÓN</label>
                            {{ form.fecha_oc }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm rounded-4 mb-4">
                <div class="card-body p-4">
                    <div class="row g-4">
                        <div class="col-12 col-lg-6">
                            <label class="form-label small fw-bold text-dark">PROVEEDOR *</label>
                            {{ form.proveedor }}
                            {{ form.proveedor_nombre.as_hidden }}
                            {{ form.proveedor_cuit.as_hidden }}
                        </div>

                        <div class="col-md-6 col-lg-3">
                            <label class="form-label small fw-bold text-dark">RUBRO PRINCIPAL</label>
                            {{ form.rubro_principal }}
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <label class="form-label small fw-bold text-dark">ÁREA SOLICITANTE</label>
                            {{ form.area|add_class:"form-select" }}
                        </div>

                        <div class="col-12">
                            <div class="p-3 bg-primary bg-opacity-10 border border-primary border-opacity-25 rounded-3">
                                <label class="form-label small fw-bold text-primary mb-1">
                                    <i class="bi bi-person-heart me-1"></i>BENEFICIARIO / VECINO (OPCIONAL)
                                </label>
                                {{ form.persona }}
                                <div class="form-text text-primary opacity-75 small fst-italic mt-1">
                                    <i class="bi bi-info-circle me-1"></i>Si esta compra es una ayuda directa (ej: materiales), seleccione al vecino aquí.
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden">
                <div class="card-header bg-dark text-white py-3 px-4 d-flex justify-content-between align-items-center">
                    <span class="fw-bold text-uppercase small ls-1"><i class="bi bi-list-check me-2"></i>Detalle de Items</span>
                    <div class="bg-white text-dark rounded-pill px-4 py-1 fw-bold shadow-sm d-flex align-items-center gap-2">
                        <span class="small text-secondary text-uppercase">Total:</span>
                        <span id="totalDisplay" class="font-monospace fs-5">$ 0,00</span>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle table-relaxed" id="tablaItems">
                        <thead class="bg-light text-secondary small text-uppercase fw-bold">
                            <tr>
                                <th class="ps-4" style="width: 25%;">Categoría</th>
                                <th style="width: 15%;">Área Item</th>
                                <th style="width: 35%;">Descripción</th>
                                <th class="text-end pe-4" style="width: 20%;">Monto ($)</th>
                                <th class="text-center" style="width: 5%;"></th>
                            </tr>
                        </thead>
                        <tbody id="lineas-container">
                            {{ lineas.management_form }}
                            
                            {% for form in lineas %}
                                <tr class="linea-row bg-white">
                                    {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
                                    <td class="ps-4">{{ form.categoria }}</td>
                                    <td>{{ form.area }}</td>
                                    <td>{{ form.descripcion }}</td>
                                    <td class="pe-4">
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text bg-light border-end-0 text-muted">$</span>
                                            {{ form.monto }}
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        {% if lineas.can_delete %}
                                            <div class="d-none">{{ form.DELETE }}</div> 
                                            <button type="button" class="btn btn-sm btn-outline-danger border-0 btn-delete-row shadow-none" title="Eliminar fila">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="p-3 bg-light border-top text-center">
                    <button type="button" id="add-row" class="btn btn-outline-primary btn-sm fw-bold border-2 rounded-pill px-4 hover-lift">
                        <i class="bi bi-plus-lg me-1"></i> AGREGAR ÍTEM
                    </button>
                </div>
            </div>

            <div class="card border-0 shadow-sm rounded-4 mb-5">
                <div class="card-body p-4">
                    <label class="form-label small fw-bold text-dark text-uppercase">Notas Adicionales</label>
                    {{ form.observaciones }}
                </div>
            </div>

        </form>
    </div>
</div>

<script type="text/template" id="empty-row-template">
    <tr class="linea-row bg-white animate-fade-in">
        <td class="ps-4">
            <select name="lineas-__prefix__-categoria" class="form-select form-select-sm" id="id_lineas-__prefix__-categoria">
                {% for x, y in lineas.empty_form.fields.categoria.choices %}<option value="{{ x }}">{{ y }}</option>{% endfor %}
            </select>
        </td>
        <td>
            <select name="lineas-__prefix__-area" class="form-select form-select-sm" id="id_lineas-__prefix__-area">
                {% for x, y in lineas.empty_form.fields.area.choices %}<option value="{{ x }}">{{ y }}</option>{% endfor %}
            </select>
        </td>
        <td>
            <input type="text" name="lineas-__prefix__-descripcion" class="form-control form-control-sm" placeholder="Detalle del ítem..." id="id_lineas-__prefix__-descripcion">
        </td>
        <td class="pe-4">
            <div class="input-group input-group-sm">
                <span class="input-group-text bg-light border-end-0 text-muted">$</span>
                <input type="number" name="lineas-__prefix__-monto" step="0.01" class="form-control text-end no-arrow" placeholder="0.00" id="id_lineas-__prefix__-monto">
            </div>
        </td>
        <td class="text-center">
            <input type="checkbox" name="lineas-__prefix__-DELETE" id="id_lineas-__prefix__-DELETE" class="d-none">
            <button type="button" class="btn btn-sm btn-outline-danger border-0 btn-delete-row shadow-none">
                <i class="bi bi-trash"></i>
            </button>
        </td>
    </tr>
</script>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    
    // ============================================
    // 1. INICIALIZACIÓN DE SELECT2 (Proveedor y Persona)
    // ============================================
    const $proveedor = $('#id_proveedor');
    const $persona = $('#id_persona');
    
    // Configuración Base Bootstrap 5
    $.fn.select2.defaults.set("theme", "bootstrap-5");
    $.fn.select2.defaults.set("width", "100%");

    // PROVEEDOR (AJAX)
    $proveedor.select2({
        placeholder: 'Buscar proveedor por nombre o CUIT...',
        allowClear: true,
        ajax: {
            url: "{% url 'finanzas:oc_proveedores_suggest' %}",
            dataType: 'json',
            delay: 250,
            data: params => ({ q: params.term, page: params.page }),
            processResults: data => ({ results: data.results }),
            cache: true
        },
        minimumInputLength: 0
    });

    // Guardar nombre/cuit ocultos al seleccionar
    $proveedor.on('select2:select', function (e) {
        var data = e.params.data;
        var nombre = data.text.split('(')[0].trim();
        var cuit = "";
        
        if(data.cuit) cuit = data.cuit;
        else {
            var match = data.text.match(/\(([^)]+)\)/);
            if(match) cuit = match[1];
        }
        $('#id_proveedor_nombre').val(nombre);
        $('#id_proveedor_cuit').val(cuit);
    });

    $proveedor.on('select2:clear', function() {
        $('#id_proveedor_nombre').val('');
        $('#id_proveedor_cuit').val('');
    });

    // PERSONA (AJAX Local o Remoto según prefieras, acá uso el estándar)
    $persona.select2({
        placeholder: 'Seleccione un vecino (opcional)...',
        allowClear: true
    });


    // ============================================
    // 2. SWITCH AUTO/MANUAL (Numeración)
    // ============================================
    const radios = document.querySelectorAll('input[name="tipo_numeracion"]');
    const inputNumero = document.getElementById('id_numero');
    const helpText = document.getElementById('numHelp');

    function updateNumeracionState() {
        let checkedRadio = document.querySelector('input[name="tipo_numeracion"]:checked');
        let selected = checkedRadio ? checkedRadio.value : 'AUTO';
        
        if (selected === 'AUTO') {
            inputNumero.setAttribute('readonly', true);
            inputNumero.classList.add('bg-light');
            inputNumero.value = ''; 
            inputNumero.placeholder = "Se generará automáticamente";
            helpText.innerText = "El sistema asignará el siguiente número disponible.";
            helpText.classList.remove('text-danger');
        } else {
            inputNumero.removeAttribute('readonly');
            inputNumero.classList.remove('bg-light');
            inputNumero.placeholder = "Ej: 000504";
            helpText.innerText = "Ingrese el número del talonario físico.";
            helpText.classList.add('text-danger');
            if(document.activeElement !== inputNumero) inputNumero.focus();
        }
    }
    radios.forEach(radio => radio.addEventListener('change', updateNumeracionState));
    // Ejecutar al inicio
    if(radios.length > 0) updateNumeracionState();


    // ============================================
    // 3. FORMSET DINÁMICO
    // ============================================
    const $container = $('#lineas-container');
    const $totalForms = $('#id_lineas-TOTAL_FORMS');
    const $totalDisplay = $('#totalDisplay');

    $('#add-row').click(function() {
        var formIdx = parseInt($totalForms.val());
        
        // Clonar template
        var templateSource = document.getElementById('empty-row-template').innerHTML;
        var newRowHtml = templateSource.replace(/__prefix__/g, formIdx);
        var $newRow = $(newRowHtml);
        
        // Agregar
        $container.append($newRow);
        
        // Inicializar selects de la nueva fila (si quisieras buscadores ahí también)
        // $newRow.find('select').select2({ theme: 'bootstrap-5', width: '100%' });

        $totalForms.val(formIdx + 1);
        bindCalcEvents(); // Re-bindear eventos de cálculo
    });

    $container.on('click', '.btn-delete-row', function() {
        var $row = $(this).closest('tr');
        // Marcar checkbox hidden de DELETE
        $row.find('input[type="checkbox"]').prop('checked', true);
        $row.hide(); // Ocultar visualmente
        calcularTotal(); // Recalcular
    });


    // ============================================
    // 4. CÁLCULOS EN TIEMPO REAL
    // ============================================
    function calcularTotal() {
        let total = 0;
        $('input[name$="-monto"]').each(function() {
            var $row = $(this).closest('tr');
            // Si la fila está oculta (borrada), no sumar
            if ($row.is(':hidden')) return;
            
            let val = parseFloat($(this).val());
            if (!isNaN(val)) total += val;
        });
        
        const formatter = new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 2 });
        $totalDisplay.text(formatter.format(total));
    }

    function bindCalcEvents() {
        $('input[name$="-monto"]').off('input').on('input', calcularTotal);
    }

    // Init
    bindCalcEvents();
    calcularTotal();
});
</script>
{% endblock %}