{% extends "finanzas/base.html" %}
{% load static %}
{% load humanize %}
{% load widget_tweaks %}

{% block title %}
    {% if form.instance.pk %}Editar OC #{{ form.instance.numero }}{% else %}Nueva Orden de Compra{% endif %}
{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

<style>
    /* === ESTILOS GENERALES === */
    .form-control, .form-select { border-color: #cbd5e1; }
    .form-control:focus, .form-select:focus { border-color: #0d6efd; box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.15); }
    
    .table-relaxed td, .table-relaxed th { padding-top: 0.8rem; padding-bottom: 0.8rem; vertical-align: middle; }
    
    /* Input numérico limpio */
    .no-arrow::-webkit-outer-spin-button, .no-arrow::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .no-arrow { -moz-appearance: textfield; }

    /* Switch Custom */
    .btn-check:checked + .btn-outline-primary { background-color: #0d6efd; color: white; border-color: #0d6efd; }
    
    /* Select2 Ajustes */
    .select2-container--bootstrap-5 .select2-selection { border-color: #cbd5e1; min-height: 38px; }
    .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered { line-height: 36px; padding-left: 12px; }

    /* === TEXTAREA PRO (LA SOLUCIÓN QUIRÚRGICA) === */
    .textarea-pro {
        resize: vertical; /* Solo permite estirar hacia abajo, nunca a los costados */
        min-height: 120px; /* Altura inicial decente */
        border-radius: 12px; /* Bordes suaves */
        background-color: #f8fafc; /* Gris muy clarito */
        border: 2px solid #e2e8f0;
        transition: all 0.2s ease-in-out;
        font-size: 0.95rem;
        line-height: 1.6;
    }
    
    .textarea-pro:focus {
        background-color: #ffffff;
        border-color: #86b7fe;
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.1);
        outline: none;
    }

    /* Animaciones */
    .animate-fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
{% endblock %}

{% block content %}

<div class="row justify-content-center animate-fade-in pb-5">
    <div class="col-12 col-xl-11">

        <form method="post" novalidate id="ocForm">
            {% csrf_token %}
            
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4 gap-3">
                <div>
                    <h1 class="h3 fw-bold text-dark mb-1">
                        {% if form.instance.pk %}
                            <i class="bi bi-pencil-square me-2 text-primary"></i>Editar OC <span class="text-muted">#{{ form.instance.numero }}</span>
                        {% else %}
                            <i class="bi bi-cart-plus-fill me-2 text-primary"></i>Nueva Orden de Compra
                        {% endif %}
                    </h1>
                    <p class="text-secondary mb-0 small fw-medium">Gestión de aprovisionamiento.</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{% url 'finanzas:oc_list' %}" class="btn btn-white border shadow-sm px-3 fw-bold text-secondary hover-lift">
                        Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary shadow-sm fw-bold px-4 hover-lift">
                        <i class="bi bi-save2 me-2"></i>Guardar OC
                    </button>
                </div>
            </div>

            {% if form.errors %}
            <div class="alert alert-danger shadow-sm border-0 mb-4 rounded-3 animate-fade-in">
                <div class="d-flex align-items-center gap-3">
                    <i class="bi bi-exclamation-triangle-fill fs-4"></i>
                    <div>
                        <strong>Hay errores en el formulario:</strong>
                        <ul class="mb-0 ps-3 small">
                            {% for field in form %}
                                {% for error in field.errors %}<li>{{ field.label }}: {{ error }}</li>{% endfor %}
                            {% endfor %}
                            {% if form.non_field_errors %}<li>{{ form.non_field_errors }}</li>{% endif %}
                        </ul>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden">
                <div class="card-header bg-white py-3 px-4 border-bottom">
                    <h6 class="mb-0 fw-bold text-dark text-uppercase small ls-1">
                        <i class="bi bi-sliders me-2 text-primary"></i>Configuración
                    </h6>
                </div>
                <div class="card-body p-4 bg-light bg-opacity-50">
                    <div class="row g-4">
                        <div class="col-md-4">
                            <label class="form-label small fw-bold text-dark mb-2">MODO DE NUMERACIÓN</label>
                            <div class="d-flex gap-2">
                                {% for radio in form.tipo_numeracion %}
                                    <div class="flex-fill">
                                        {{ radio.tag }}
                                        <label class="btn btn-outline-primary btn-sm fw-bold rounded-pill w-100" for="{{ radio.id_for_label }}">
                                            {% if radio.data.value == 'AUTO' %}<i class="bi bi-magic me-1"></i>{% else %}<i class="bi bi-pen me-1"></i>{% endif %}
                                            {{ radio.choice_label }}
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label small fw-bold text-dark">N° COMPROBANTE</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0 text-muted"><i class="bi bi-hash"></i></span>
                                {{ form.numero }}
                            </div>
                            <div id="numHelp" class="form-text small mt-1 text-primary fw-bold"></div>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label small fw-bold text-dark">FECHA EMISIÓN</label>
                            {{ form.fecha_oc }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm rounded-4 mb-4">
                <div class="card-body p-4">
                    <div class="row g-4">
                        <div class="col-12 col-lg-6">
                            <label class="form-label small fw-bold text-dark">PROVEEDOR *</label>
                            {{ form.proveedor }}
                            {{ form.proveedor_nombre.as_hidden }}
                            {{ form.proveedor_cuit.as_hidden }}
                        </div>

                        <div class="col-md-6 col-lg-3">
                            <label class="form-label small fw-bold text-dark">RUBRO PRINCIPAL</label>
                            {{ form.rubro_principal }}
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <label class="form-label small fw-bold text-dark">ÁREA SOLICITANTE</label>
                            {{ form.area|add_class:"form-select" }}
                        </div>

                        <div class="col-12">
                            <div class="p-3 bg-primary bg-opacity-10 border border-primary border-opacity-25 rounded-3 position-relative">
                                <label class="form-label small fw-bold text-primary mb-1">
                                    <i class="bi bi-person-heart me-1"></i>BENEFICIARIO / VECINO (OPCIONAL)
                                </label>
                                
                                <div class="input-group">
                                    {{ form.persona }}
                                    <button type="button" class="btn btn-success fw-bold shadow-sm" data-bs-toggle="modal" data-bs-target="#modalNuevoVecino" title="Crear Nuevo Vecino">
                                        <i class="bi bi-plus-lg"></i>
                                    </button>
                                </div>
                                
                                <div class="form-text text-primary opacity-75 small fst-italic mt-1">
                                    <i class="bi bi-info-circle me-1"></i>Si esta compra es una ayuda directa (ej: materiales), seleccione al vecino aquí.
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden">
                <div class="card-header bg-dark text-white py-3 px-4 d-flex justify-content-between align-items-center">
                    <span class="fw-bold text-uppercase small ls-1"><i class="bi bi-list-check me-2"></i>Detalle de Items</span>
                    <div class="bg-white text-dark rounded-pill px-4 py-1 fw-bold shadow-sm d-flex align-items-center gap-2">
                        <span class="small text-secondary text-uppercase">Total:</span>
                        <span id="totalDisplay" class="font-monospace fs-5">$ 0,00</span>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle table-relaxed" id="tablaItems">
                        <thead class="bg-light text-secondary small text-uppercase fw-bold">
                            <tr>
                                <th class="ps-4" style="width: 25%;">Categoría</th>
                                <th style="width: 15%;">Área Item</th>
                                <th style="width: 35%;">Descripción</th>
                                <th class="text-end pe-4" style="width: 20%;">Monto ($)</th>
                                <th class="text-center" style="width: 5%;"></th>
                            </tr>
                        </thead>
                        <tbody id="lineas-container">
                            {{ lineas.management_form }}
                            
                            {% for form in lineas %}
                                <tr class="linea-row bg-white">
                                    {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
                                    <td class="ps-4">{{ form.categoria }}</td>
                                    <td>{{ form.area }}</td>
                                    <td>{{ form.descripcion }}</td>
                                    <td class="pe-4">
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text bg-light border-end-0 text-muted">$</span>
                                            {{ form.monto }}
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        {% if lineas.can_delete %}
                                            <div class="d-none">{{ form.DELETE }}</div> 
                                            <button type="button" class="btn btn-sm btn-outline-danger border-0 btn-delete-row shadow-none" title="Eliminar fila">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="p-3 bg-light border-top text-center">
                    <button type="button" id="add-row" class="btn btn-outline-primary btn-sm fw-bold border-2 rounded-pill px-4 hover-lift">
                        <i class="bi bi-plus-lg me-1"></i> AGREGAR ÍTEM
                    </button>
                </div>
            </div>

            <div class="card border-0 shadow-sm rounded-4 mb-5">
                <div class="card-header bg-white py-3 px-4 border-bottom">
                    <h6 class="mb-0 fw-bold text-dark text-uppercase small ls-1">
                        <i class="bi bi-journal-text me-2 text-primary"></i>Notas y Observaciones
                    </h6>
                </div>
                <div class="card-body p-4">
                    {{ form.observaciones|add_class:"form-control textarea-pro" }}
                    
                    <div class="form-text small text-muted mt-2 d-flex align-items-center gap-1">
                        <i class="bi bi-info-circle"></i>
                        <span>Puede detallar condiciones de entrega, plazos de pago o referencias internas.</span>
                    </div>
                </div>
            </div>

        </form>
    </div>
</div>

<div class="modal fade" id="modalNuevoVecino" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header bg-success text-white border-bottom-0 rounded-top-4">
                <h5 class="modal-title fw-bold"><i class="bi bi-person-plus-fill me-2"></i>Nuevo Vecino Rápido</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4 pt-3">
                <div id="modalAlert" class="alert alert-danger d-none small mb-3"></div>
                
                <form id="formNuevoVecino" method="post">
                    {% csrf_token %}
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted">Nombre</label>
                            {{ beneficiario_form.nombre }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted">Apellido</label>
                            {{ beneficiario_form.apellido }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted">DNI</label>
                            {{ beneficiario_form.dni }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted">Teléfono</label>
                            {{ beneficiario_form.telefono }}
                        </div>
                        <div class="col-12">
                            <label class="form-label small fw-bold text-muted">Dirección</label>
                            {{ beneficiario_form.direccion }}
                        </div>
                    </div>
                    <div class="d-grid mt-4">
                        <button type="button" id="btnGuardarVecino" class="btn btn-success fw-bold rounded-pill">
                            <i class="bi bi-check-lg me-2"></i>Guardar y Seleccionar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script type="text/template" id="empty-row-template">
    <tr class="linea-row bg-white animate-fade-in">
        <td class="ps-4">
            <select name="lineas-__prefix__-categoria" class="form-select form-select-sm">
                {% for x, y in lineas.empty_form.fields.categoria.choices %}<option value="{{ x }}">{{ y }}</option>{% endfor %}
            </select>
        </td>
        <td>
            <select name="lineas-__prefix__-area" class="form-select form-select-sm">
                {% for x, y in lineas.empty_form.fields.area.choices %}<option value="{{ x }}">{{ y }}</option>{% endfor %}
            </select>
        </td>
        <td>
            <input type="text" name="lineas-__prefix__-descripcion" class="form-control form-control-sm" placeholder="Detalle del ítem...">
        </td>
        <td class="pe-4">
            <div class="input-group input-group-sm">
                <span class="input-group-text bg-light border-end-0 text-muted">$</span>
                <input type="number" name="lineas-__prefix__-monto" step="0.01" class="form-control text-end no-arrow input-monto" placeholder="0.00">
            </div>
        </td>
        <td class="text-center">
            <input type="checkbox" name="lineas-__prefix__-DELETE" class="d-none">
            <button type="button" class="btn btn-sm btn-outline-danger border-0 btn-delete-row shadow-none">
                <i class="bi bi-trash"></i>
            </button>
        </td>
    </tr>
</script>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    
    // ============================================
    // 1. SELECT2 PROVEEDOR & PERSONA
    // ============================================
    const $proveedor = $('#id_proveedor');
    const $persona = $('#id_persona_select');
    
    $.fn.select2.defaults.set("theme", "bootstrap-5");
    $.fn.select2.defaults.set("width", "100%");

    // Proveedor Ajax
    $proveedor.select2({
        placeholder: 'Buscar proveedor...',
        allowClear: true,
        ajax: {
            url: "{% url 'finanzas:oc_proveedores_suggest' %}",
            dataType: 'json',
            delay: 250,
            data: params => ({ q: params.term }),
            processResults: data => ({ results: data.results }),
            cache: true
        }
    });

    $proveedor.on('select2:select', function (e) {
        var data = e.params.data;
        $('#id_proveedor_nombre').val(data.nombre);
        $('#id_proveedor_cuit').val(data.cuit);
    });

    // Persona (Vecino) Simple
    $persona.select2({
        placeholder: 'Seleccione vecino...',
        allowClear: true
    });


    // ============================================
    // 2. MODAL NUEVO VECINO (AJAX)
    // ============================================
    $('#btnGuardarVecino').click(function() {
        const btn = $(this);
        const originalText = btn.html();
        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Guardando...');
        
        $.ajax({
            url: "{% url 'finanzas:api_beneficiario_create' %}",
            type: "POST",
            data: $('#formNuevoVecino').serialize(),
            success: function(response) {
                if(response.success) {
                    // 1. Cerrar Modal
                    var modalEl = document.getElementById('modalNuevoVecino');
                    var modal = bootstrap.Modal.getInstance(modalEl);
                    modal.hide();
                    
                    // 2. Crear la opción y seleccionarla en Select2
                    var newOption = new Option(response.text, response.id, true, true);
                    $persona.append(newOption).trigger('change');
                    
                    // 3. Limpiar form
                    $('#formNuevoVecino')[0].reset();
                } else {
                    $('#modalAlert').text("Error: " + response.error).removeClass('d-none');
                }
            },
            error: function() {
                $('#modalAlert').text("Error de conexión con el servidor.").removeClass('d-none');
            },
            complete: function() {
                btn.prop('disabled', false).html(originalText);
            }
        });
    });


    // ============================================
    // 3. SWITCH NUMERACIÓN AUTO/MANUAL
    // ============================================
    const radios = document.querySelectorAll('input[name="tipo_numeracion"]');
    const inputNumero = document.getElementById('id_numero');
    
    function updateNumeracion() {
        let checked = document.querySelector('input[name="tipo_numeracion"]:checked');
        let val = checked ? checked.value : 'AUTO';
        
        if (val === 'AUTO') {
            inputNumero.setAttribute('readonly', true);
            inputNumero.classList.add('bg-light');
            inputNumero.value = '';
            inputNumero.placeholder = "Automático al guardar";
            $('#numHelp').text('');
        } else {
            inputNumero.removeAttribute('readonly');
            inputNumero.classList.remove('bg-light');
            inputNumero.placeholder = "Ej: 000123";
            $('#numHelp').text('Ingrese el número del talonario físico.');
        }
    }
    radios.forEach(r => r.addEventListener('change', updateNumeracion));
    updateNumeracion(); // Init


    // ============================================
    // 4. FORMSET Y CÁLCULOS
    // ============================================
    const $container = $('#lineas-container');
    const $totalForms = $('#id_lineas-TOTAL_FORMS');
    const $totalDisplay = $('#totalDisplay');

    function calcularTotal() {
        let total = 0;
        // Buscamos todos los inputs que terminen en -monto
        $container.find('input[name$="-monto"]').each(function() {
            var $row = $(this).closest('tr');
            if ($row.is(':hidden')) return; // Ignorar eliminados
            
            let val = parseFloat($(this).val());
            if (!isNaN(val)) total += val;
        });
        
        const formatter = new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' });
        $totalDisplay.text(formatter.format(total));
    }

    // Agregar Fila
    $('#add-row').click(function() {
        var formIdx = parseInt($totalForms.val());
        var template = document.getElementById('empty-row-template').innerHTML;
        var newHtml = template.replace(/__prefix__/g, formIdx);
        
        $container.append(newHtml);
        $totalForms.val(formIdx + 1);
        
        // Rebindear evento input para la nueva fila
        $container.find('input[name$="-monto"]').last().on('input', calcularTotal);
    });

    // Eliminar Fila
    $container.on('click', '.btn-delete-row', function() {
        var $row = $(this).closest('tr');
        $row.find('input[type="checkbox"]').prop('checked', true);
        $row.hide();
        calcularTotal();
    });

    // Bind inicial
    $('input[name$="-monto"]').on('input', calcularTotal);
    calcularTotal(); // Calc inicial por si es edición
});
</script>
{% endblock %}